---
title: "HDAT9600 Final Assignment"
subtitle: "Please see course outline / 'Announcements' for submission deadline"
author: "insert your team name here"
date: "insert date of completion here"
output: html_document
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)
```

## Instructions

This file (hdat9600_final_assignment.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final assignment. This assignment is assessed and will count for 30% of the total course marks. The assignment comprises two tasks worth 15 marks each. The first task will focus on logistic regression, and the second task will focus on survival analysis. There is no word limit, but a report of about 10 pages in length when printed (except that it will not be printed) is appropriate.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor are happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assignments for you!


## Data for this assignment

The data used for this assignment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assignment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. The original data has been modified and assembled to suit the purpose of this assignment. While not required for the purposes of this assignment, full details of the preparatory work can be found in the hdat9600_final_assignment_data_preparation file.

The dataframe consists of 120 variables, which are defined as follows:

#### Patient Descriptor Variables
<li> <em>RecordID:</em>            a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patientâ€™s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


#### Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


#### Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

<li> <em>SAPS-I score</em> [Simplified Acute Physiological Score (<a href="http://www.ncbi.nlm.nih.gov/pubmed/6499483"
target="_blank"><em>Le Gall et al., 1984</em></a>)]</li>
<li> <em>SOFA score</em> [Sequential Organ Failure Assessment (<a href="http://www.ncbi.nlm.nih.gov/pubmed/11594901"
target="_blank"><em>Ferreira et al., 2001</em></a>)]</li>

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

<li><a href="http://en.wikipedia.org/wiki/Human_serum_albumin" target="_blank">
<em>Albumin</em></a> (g/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Alkaline_phosphatase" target="_blank">
<em>ALP</em></a> [Alkaline phosphatase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Alanine_transaminase" target="_blank">
<em>ALT</em></a> [Alanine transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Aspartate_transaminase" target="_blank">
<em>AST</em></a> [Aspartate transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bilirubin" target="_blank">
<em>Bilirubin</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/BUN" target="_blank">
<em>BUN</em></a> [Blood urea nitrogen (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Cholesterol" target="_blank">
<em>Cholesterol</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine"
target="_blank">
<em>Creatinine</em></a> [Serum creatinine (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>DiasABP</em></a> [Invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/FIO2" target="_blank">
<em>FiO2</em></a> [Fractional inspired O<sub>2</sub> (0-1)]</li>
<li><a href="http://en.wikipedia.org/wiki/Glasgow_coma_score" target="_blank">
<em>GCS</em></a> [Glasgow Coma Score (3-15)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_glucose" target="_blank">
<em>Glucose</em></a> [Serum glucose (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics"
target="_blank">
<em>HCO3</em></a> [Serum bicarbonate (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hematocrit" target="_blank">
<em>HCT</em></a> [Hematocrit (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Heart_rate" target="_blank">
<em>HR</em></a> [Heart rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hypokalemia" target="_blank">
<em>K</em></a> [Serum potassium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Lactic_acid" target="_blank">
<em>Lactate</em></a> (mmol/L)</li>
<li><a href="http://en.wikipedia.org/wiki/Magnesium#Biological_role"
target="_blank">
<em>Mg</em></a> [Serum magnesium (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>MAP</em></a> [Invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mechanical_ventilation"
target="_blank">
<em>MechVent</em></a> [Mechanical ventilation respiration (0:false, or 1:true)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_sodium" target="_blank">
<em>Na</em></a> [Serum sodium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>NIDiasABP</em></a> [Non-invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>NIMAP</em></a> [Non-invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>NISysABP</em></a> [Non-invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaCO2</em></a> [partial pressure of arterial CO<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaO2</em></a> [Partial pressure of arterial O<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>pH</em></a> [Arterial pH (0-14)]</li>
<li><a href="http://en.wikipedia.org/wiki/Platelets" target="_blank">
<em>Platelets</em></a> (cells/nL)</li>
<li><a href="http://en.wikipedia.org/wiki/Respiratory_physiology" target="_blank">
<em>RespRate</em></a> [Respiration rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>SaO2</em></a> [O<sub>2</sub> saturation in hemoglobin (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>SysABP</em></a> [Invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Normal_human_body_temperature"
target="_blank">
<em>Temp</em></a> [Temperature (&deg;C)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropI</em></a> [Troponin-I (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropT</em></a> [Troponin-T (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Fluid_balance" target="_blank">
<em>Urine</em></a> [Urine output (mL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology" target="_blank">
<em>WBC</em></a> [White blood cell count (cells/nL)]</li>
<li>
<em>Weight</em> (kg)</li>


## Accessing the Data
The data frame can be loaded with the following code:

``` {r task-setup}

# Getting the path of your current open file
# Extra code to ensure this file imports birth.csv in local directory for everyone
library(rstudioapi)
current_path <- rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path ))

icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")

```
**Note:** icu_patients_df1 is an imputed (i.e. missing values are 'derived') version of icu_patients_df0.  This assignment does not concern the methods used for imputation.


# Task 1 (15 marks)

In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately explains or predicts the `in_hospital_death` variable as the outcome using a subset of the available predictor variables. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct or complete, but do you best). Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of diagnostic statistics and/or charts and comment on them. You don't need to do an exhaustive exploratory data analysis of all the variables in the data set, but you should examine those variables that you use in your model. Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


### Hints

1. Select an initial subset of explanatory variables that you will use to predict the risk of in-hospital death. Justify your choice.

**Selecting an initial subset of explanatory variables:

To select a subset of explanatory variables our group of investigators will examine the SAPS1 score and the SOFA score included in the dataset in more detail to ascertain the variables that might be logically associated with increased mortality and poor survival. We will also assess the APACHE score which is commonly used in ICU risk predcition models.

`SAPS1` - Simplified Acute Physiology Score is a measure of the severity of disease for patients admitted to ICU. The following measures increases the SAPS1 score:

  * Advanced Age
  * Low and high Heart Rate
  * Low and high Systolic Blood Pressure
  * High Temperature
  * Low Glasgow Coma Scale (However it is most meaningful to use the highest GCS score available for prognostication)
  * Mechanical Ventilation or CPAP
  * High PaO2/ FiO2 ratio (It is likely that highes FiO2 is administered during lowest PaO2)
  * Low Urine Output
  * High Blood Urea Nitrogen
  * Low or High Sodium
  * Low or high Potassium
  * Low Bicarbonate
  * High Bilirubin
  * Low or High White Blood Cell
  * Chronic diseases
  * Type of admission (ie ICU Type)

*`SOFA` - sequential organ failure assessment is a predictor of ICU mortality. The following measures increase the SOFA score:
  * Elevated PaO2/ FiO2 ratio- 
  * Reduced GCS - Nervous system
  * Reduced MAP - Cardiovascular system
  * Administration of vasopressors - Cardiovascular system
  * High Bilirubin - Liver
  * Low Platelets - Coagulation
  * High Creatinine - Kidneys
  * Low Urine - Kidneys
  
  
*The `APACHE` score is commonly used validated risk score for ICU risk prediction. The variables that increase the APACHE score include:

  * Advanced Age
  * High or Low Temperature
  * High or Low MAP
  * High or Low HR
  * High or Low Respiratory Rate
  * High PaO2/FiO2 ratio
  * High or Low pH
  * High or Low Na
  * High or Low K
  * High Creatinine
  * High or low HCT
  * High or Low WBC


* For our analysis, we will include variables that will increase SOFA, SAPS or APACHE scores. 
        eg: increased BUN and reduced HCO3 will increase the SAPS score, therfore we will include BUN max(but not BUN_min and BUN_diff) and 
        HCO3_min (but not HCO3_max and HCO3_diff). Where both extremes of a variable will increase the risk score, both min and max variables will 
        be included.
        
* Other factors known to be associated with morbidity/ mortality not included in risk scores: 
  * Height/ weight - Body composition/ BMI is associated with mortality and survival
  * Gender - Male gender associated with worse outcomes
  * Glucose - high and low Glucose levels are associated with pathology
  * Troponin T and I - high troponin results(cardiac biomarkers) associated with morbidity and mortality
  * Lactate - elevated lactate is associated with poor organ perfusion and ICU morbidity/ mortality
  * Albumin - reduced albumin is associated with poor clinical outcomes
        
***BELOW IS A LIST OF THE VARIABLES TO BE INCLUDED:***
DEMOGRAPHIC VARAIBLES:
  * Age
  * Gender
  * ICU Type
  * Height 
  * Weight_max
  
CLINICAL VARIABLES:
  * Albumin_min
  * Bilirubin_max 
  * BUN_max
  * Creatinine_max  
  * GCS_min
  * Glucose_min and Glucose_max
  * HCO3_min
  * HR_min and HR_max 
  * K_min K_max
  * Lactate_max
  * MAP_min  
  * Na_min and Na_max 
  * NISysABP_min and NISysABP_max 
  * Platelets_min
  * FiO2_max and PaO2_min - included as PFratio: PaO2_min/ FiO2_max
  * pH_min and pH_max
  * RespRate_min and RespRate_max
  * Temp_min and Temp_max
  * TroponinI_max
  * TroponinT_max
  * Urine_min 
  * WBC_min and WBC_max

``` {r task1.1}
summary(icu_patients_df1)
head(icu_patients_df1)

```

2. Conduct basic exploratory data analysis on your variables of choice.

``` {r task1.2}
library(ggplot2)

#################################################################################
### CODE COPIED FROM TASK 2
# create new variable PF ratio as part of our list of variables to include
icu_patients_df1$PFratio<-icu_patients_df1$PaO2_min/icu_patients_df1$FiO2_max
### CODE COPIED FROM TASK 2
#################################################################################

summary(icu_patients_df1$Height) #max height is 426.7cm!? and min is 13.0cm - seems wrong


# Basic EDA for each variable

table(icu_patients_df1$in_hospital_death) #297 deaths out of 2016 observations = 14.4%


# Write a function to plot box plots for each variable by in_hospital_death
boxplot_eda <- function(variable){
  ggplot(data=icu_patients_df1, 
         mapping = aes(x = in_hospital_death=="1", 
                       y = icu_patients_df1[,variable])) + 
    geom_boxplot() +
    labs(title=paste('Box plot of',variable), x='In hospital death', y=variable)
}

# test function
# boxplot_eda('Albumin_min')


### Continuous variables EDA and their interpretation ###

#################################################################################
### CODE COPIED FROM TASK 2
# continuous variables from the list of initial subset of explanatory variables
cont_vars <- c('Age', 'Height', 'Weight_max', 'Albumin_min', 'Bilirubin_max',
               'BUN_max', 'Creatinine_max', 'GCS_min', 'Glucose_min',
               'Glucose_max', 'HCO3_min', 'HR_min', 'HR_max', 'K_min', 'K_max',
               'Lactate_max', 'MAP_min', 'Na_min', 'Na_max', 'NISysABP_min',
               'NISysABP_max', 'Platelets_min', 'PFratio', 'pH_min', 'pH_max',
               'RespRate_min', 'RespRate_max', 'Temp_min', 'Temp_max',
               'TroponinI_max', 'TroponinT_max', 'Urine_min', 'WBC_min', 'WBC_max')
### CODE COPIED FROM TASK 2
#################################################################################

par(mfrow=c(12,3)) # set the layout of the histograms in 12 row x 3 column grid
for(i in 1:length(cont_vars)){
  print(boxplot_eda(cont_vars[i]))
}

# Higher age in those that died
# Some extreme illogical outliers in height variable
# Similar weight median / IQR in both groups, but more high outliers in the alive group
# Higher min albumin in those that died
# Slightly higher max bilirubin in those that died
# Higher max urea in those that died
# Higher max creatinine in those that died
# Lower GCS min in those that died
# Similar min glucose in both groups
# Slightly higher max glucose in those that died
# Lower min HCO3 in those that died
# Similar min HR in both groups
# Slightly higher max HR in those that died
# Similar min K in both groups
# Similar max K in both groups
# Slightly higher max lactate in those that died
# Similar min MAP in both groups
# Similar min Na in both groups
# Similar max Na in both groups
# Slightly lower min NISysABP in those that died
# Similar max NISysABP in both groups
# Similar min platelets in both groups
# Similar PF ratio in both groups
# Similar min pH in both groups - one extreme outlier
# Similar pH max in both groups
# Higher min RR in those that died
# Higher max RR in those that died
# Similar min temp in both groups
# Similar max temp in both groups
# Similar max troponinI in both groups
# Similar max troponinT in both groups
# Similar min urine in both groups
# Slightly higher min WBC in those that died
# Slightly higher max WBC in those that died

# Patients who died had higher SAPS1 and SOFA scores
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = SAPS1))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = SOFA))+ geom_boxplot()

### Categorical variables EDA and their interpretation ###

# cardiac surgery recovery unit have a smaller death circle compared to the other 3 ICU units
# ie less proportion of in hospital deaths compared to alive
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = ICUType)) + 
  geom_count(aes(size = after_stat(prop), group = ICUType)) + 
  scale_size_area(max_size = 10)

# difficult to say, roughly same amount of men/women died as a proportion of the alive group
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Gender)) + 
  geom_count(aes(size = after_stat(prop), group = ICUType)) + 
  scale_size_area(max_size = 20)









```

3. Fit appropriate univariate logistic regression models.

``` {r task1.3}
# univariate comparisons above
# removed: Mg_min, Na_min, Na_max, MAP_diff, MAP_max
# now in order as per above list


age_glm <- glm(in_hospital_death ~ Age, data=icu_patients_df1, family="binomial")
summary(age_glm) # is significant

gender_glm <- glm(in_hospital_death ~ Gender, data=icu_patients_df1, family="binomial")
summary(gender_glm) # NOT significant

icuType_glm <- glm(in_hospital_death ~ ICUType, data=icu_patients_df1, family="binomial")
summary(icuType_glm) # cardiac surgery recovery unit is significant

# height variable not used

maxWeight_glm <- glm(in_hospital_death ~ Weight_max, data=icu_patients_df1, family="binomial")
summary(maxWeight_glm) # is significant

minAlbumin_glm <- glm(in_hospital_death ~ Albumin_min, data=icu_patients_df1, family="binomial")
summary(minAlbumin_glm) # is significant

maxBili_glm <- glm(in_hospital_death ~ Bilirubin_max, data=icu_patients_df1, family="binomial")
summary(maxBili_glm) # is significant

maxUrea_glm <- glm(in_hospital_death ~ BUN_max, data=icu_patients_df1, family="binomial")
summary(maxUrea_glm) # is significant

maxCr_glm <- glm(in_hospital_death ~ Creatinine_max, data=icu_patients_df1, family="binomial")
summary(maxCr_glm) # is significant

minGCS_glm <- glm(in_hospital_death ~ GCS_min, data=icu_patients_df1, family="binomial")
summary(minGCS_glm) # is significant

minGlu_glm <- glm(in_hospital_death ~ Glucose_min, data=icu_patients_df1, family="binomial")
summary(minGlu_glm) # NOT significant

maxGlu_glm <- glm(in_hospital_death ~ Glucose_max, data=icu_patients_df1, family="binomial")
summary(maxGlu_glm) # is significant

minHCO3_glm <- glm(in_hospital_death ~ HCO3_min, data=icu_patients_df1, family="binomial")
summary(minHCO3_glm) # is significant

minHR_glm <- glm(in_hospital_death ~ HR_min, data=icu_patients_df1, family="binomial")
summary(minHR_glm) # NOT significant

maxHR_glm <- glm(in_hospital_death ~ HR_max, data=icu_patients_df1, family="binomial")
summary(maxHR_glm) # is significant

minK_glm <- glm(in_hospital_death ~ K_min, data=icu_patients_df1, family="binomial")
summary(minK_glm) # NOT significant

maxK_glm <- glm(in_hospital_death ~ K_max, data=icu_patients_df1, family="binomial")
summary(maxK_glm) # NOT significant

maxLactate_glm <- glm(in_hospital_death ~ Lactate_max, data=icu_patients_df1, family="binomial")
summary(maxLactate_glm) # is significant

minMAP_glm <- glm(in_hospital_death ~ MAP_min, data=icu_patients_df1, family="binomial")
summary(minMAP_glm) # NOT significant

minNa_glm <- glm(in_hospital_death ~ Na_min, data=icu_patients_df1, family="binomial")
summary(minNa_glm) # is significant

maxNa_glm <- glm(in_hospital_death ~ Na_max, data=icu_patients_df1, family="binomial")
summary(maxNa_glm) # NOT significant

minNISys_ABP_glm <- glm(in_hospital_death ~ NISysABP_min, data=icu_patients_df1, family="binomial")
summary(minNISys_ABP_glm) # is significant

maxNISys_ABP_glm <- glm(in_hospital_death ~ NISysABP_max, data=icu_patients_df1, family="binomial")
summary(maxNISys_ABP_glm) # NOT significant

minPlt_glm <- glm(in_hospital_death ~ Platelets_min, data=icu_patients_df1, family="binomial")
summary(minPlt_glm) # NOT significant

maxPFratio_glm <- glm(in_hospital_death ~ PFratio, data=icu_patients_df1, family="binomial")
summary(maxPFratio_glm) # NOT significant

minpH_glm <- glm(in_hospital_death ~ pH_min, data=icu_patients_df1, family="binomial")
summary(minpH_glm) # is significant

maxpH_glm <- glm(in_hospital_death ~ pH_max, data=icu_patients_df1, family="binomial")
summary(maxpH_glm) # NOT significant

minRR_glm <- glm(in_hospital_death ~ RespRate_min, data=icu_patients_df1, family="binomial")
summary(minRR_glm) # is significant

maxRR_glm <- glm(in_hospital_death ~ RespRate_max, data=icu_patients_df1, family="binomial")
summary(maxRR_glm) # is significant

minTemp_glm <- glm(in_hospital_death ~ Temp_min, data=icu_patients_df1, family="binomial")
summary(minTemp_glm) # is significant

maxTemp_glm <- glm(in_hospital_death ~ Temp_max, data=icu_patients_df1, family="binomial")
summary(maxTemp_glm) # NOT significant

maxTropI_glm <- glm(in_hospital_death ~ TroponinI_max, data=icu_patients_df1, family="binomial")
summary(maxTropI_glm) # NOT significant

maxTropT_glm <- glm(in_hospital_death ~ TroponinT_max, data=icu_patients_df1, family="binomial")
summary(maxTropT_glm) # is significant

minUrine_glm <- glm(in_hospital_death ~ Urine_min, data=icu_patients_df1, family="binomial")
summary(minUrine_glm) # is significant

minWBC_glm <- glm(in_hospital_death ~ WBC_min, data=icu_patients_df1, family="binomial")
summary(minWBC_glm) # is significant

maxWBC_glm <- glm(in_hospital_death ~ WBC_max, data=icu_patients_df1, family="binomial")
summary(maxWBC_glm) # is significant



### IN SUMMARY:
# significant variables were:
  # age
  # ICUType
  # Weight_max
  # Albumin_min
  # Bilirubin_max
  # BUN_max
  # Creatinine_max
  # GCS_min
  # Glucose_max
  # HCO3_min
  # HR_max
  # Lactate_max
  # Na_min
  # NISysABP_min
  # pH_min
  # RespRate_min
  # RespRate_max
  # Temp_min
  # TroponinT_max
  # Urine_min
  # WBC_min
  # WBC_max

# non-significant variables were:
  # Glucose_min
  # HR_min
  # K_min
  # K_max
  # MAP_min
  # Na_max
  # NISysABP_max
  # Platelets_min
  # PFratio
  # pH_max
  # Temp_max
  # TroponinI_max


```

4. Fit an appropriate series of multivariable logistic regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

``` {r task1.4}

#################################################################################
### CODE COPIED FROM TASK 2
## Create a dataset without missing or invalid data to use to build the model ##
## in order to remain consistent and allow comparisons between models to be made ##


# Check counts of missing data in each variable
for(i in 1:length(colnames(icu_patients_df1))){
  print(c(i,colnames(icu_patients_df1[i]), sum(is.na(icu_patients_df1[i]))))
}
## Result: of the variables chosen to explore for the survival model, large amounts of missing data in:
##         Height (992), NISysABP_min (453), NISysABP_max (453), Weight_max (146)

## Decision: include Weight_max; remove Height, NISysABP_min, NISysABP_max


# Check counts of negative data (noted some -1 values) in each variable
for(i in 1:length(colnames(icu_patients_df1))){
  print(c(i,colnames(icu_patients_df1[i]), sum(icu_patients_df1[i] < 0)))
}
## Result: negative values in Length_of_stay and SOFA (not listed in initial choice of variables anyway)

# Create a new dataset with the only non-missing data from list of initial variables chosen
# (excluding those with very high missingness i.e. Height, NISysABP_min, NISysABP_max)
nm_icu_model_df1 <- na.omit(subset(icu_patients_df1, 
                                   select=c(Days, Status, # the survival object variables
                                            RecordID, # keep record id for reference if needed
                                            in_hospital_death, # for task 1
                                            Age, Gender, ICUType, Weight_max,
                                            Albumin_min, Bilirubin_max,
                                            BUN_max, Creatinine_max, 
                                            GCS_max, Glucose_min, Glucose_max, 
                                            HCO3_min, HR_min, HR_max, K_min, 
                                            K_max, Lactate_max, MAP_min, Na_min,
                                            Na_max, Platelets_min, PFratio, pH_min,
                                            pH_max, RespRate_min, RespRate_max,
                                            Temp_min, Temp_max, TroponinT_max, 
                                            TroponinI_max, Urine_min, WBC_min, WBC_max)))
### CODE COPIED FROM TASK 2
#################################################################################

# all variables from initially selected predictors
full_glm <- glm(in_hospital_death ~ 
                  Age + 
                  Gender + 
                  ICUType + 
                  Weight_max +
                  Albumin_min +
                  Bilirubin_max + 
                  BUN_max + 
                  Creatinine_max + 
                  GCS_max + 
                  Glucose_min + 
                  Glucose_max + 
                  HCO3_min +
                  HR_min + 
                  HR_max + 
                  K_min + 
                  K_max + 
                  Lactate_max + 
                  MAP_min + 
                  Na_min +
                  Na_max +
                  Platelets_min +
                  PFratio +
                  pH_min +
                  pH_max +
                  RespRate_min +
                  RespRate_max + 
                  Temp_min + 
                  Temp_max +
                  TroponinT_max +
                  TroponinI_max + 
                  Urine_min + 
                  WBC_min + 
                  WBC_max
                ,data=nm_icu_model_df1, family="binomial")
summary(full_glm) #AIC 1332.1



###
# variables that were significant on univariate comparisons
signifUni_glm <- glm(in_hospital_death ~
                       Age + 
                       ICUType + 
                       Weight_max +
                       Albumin_min + 
                       Bilirubin_max + 
                       BUN_max + 
                       Creatinine_max +
                       GCS_max + 
                       Glucose_max + 
                       HCO3_min + 
                       HR_max +
                       Lactate_max +
                       Na_min +
                       # NISysABP_min + this was removed from the na.omit part anyway
                       pH_min + 
                       RespRate_min +
                       RespRate_max +
                       Temp_min + 
                       TroponinT_max +
                       Urine_min +
                       WBC_min +
                       WBC_max
                     ,data=nm_icu_model_df1, family="binomial")
summary(signifUni_glm) #AIC 1320.9



###
# variables that were significant in the full_glm
signifFull_glm <- glm(in_hospital_death ~
                        Age + 
                        ICUType +
                        Albumin_min + 
                        Bilirubin_max + 
                        BUN_max + 
                        GCS_max + 
                        Temp_min + 
                        Urine_min + 
                        WBC_min + 
                        WBC_max
                      ,data=nm_icu_model_df1, family="binomial")
summary(signifFull_glm) #AIC 1330.2
# no missing data removed due to missingness

# anova doesn't work because different missing data between the models
anova(full_glm, signifUni_glm, test="Chisq") # the parameters different between the models are not significant
anova(full_glm, signifFull_glm, test="Chisq") # the dropped parameters between the two models do matter


###
# using the model with the lowest AIC
# reduce it even further
reduced_signifUni_glm <- step(signifUni_glm, trace=1)
# removed variables were:
  # Glucose_max
  # TroponinT_max
  # HCO3_min
  # RespRate_min
  # Weight_max
  # RespRate_max
  # Creatinine_max
summary(reduced_signifUni_glm) # AIC 1311.1

anova(reduced_signifUni_glm,signifUni_glm, test="Chisq") 
# p value not significant, the dropped parameters are not significant



```

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.
```{r task1.5}

# same as model above: reduced_signifUni_glm
finalICU_glm <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max
                    ,data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm) # AIC 1311.1


### testing interactions

# finalICU_glm_AgeCr = finalICU_glm + Age:Creatinine_max
finalICU_glm_AgeCr <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      
                        # interaction term  
                      + Age:Creatinine_max # creatinine generally increases with age
                    ,data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm_AgeCr) # AIC 1311.6

# finalICU_glm_AgeTemp = finalICU_glm + Age:Temp_min
finalICU_glm_AgeTemp <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      
                        # interaction term  
                      + Age:Temp_min # low temp more often associated with illness in the elderly e.g. cold sepsis
                    ,data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm_AgeTemp) # AIC 1313.1

# finalICU_glm_AgeWeight = finalICU_glm + Age:Weight_max (rather than using Weight_min previously)

# finalICU_glm_AgeAlbumin = finalICU_glm + Age:Albumin_min

# finalICU_glm_AgeICUType = finalICU_glm + Age:ICUType

# Code from previous attempt at task 1
# Gender:HCT, PaO2:RespRate not tested because they are not in the final model

# Anova testing for the new models

```


Test some interaction terms based on clinical knowledge

```{r testing-interactions}

#################################################################################
# TO BE DELETED FROM HERE



# based on clinical knowledge, test some interaction terms
# add one new term on top of finalICU_glm per model
# then compare models with interactions with baseline model

# finalICU_glm_2 = finalICU_glm + Age:Creatinine_max
finalICU_glm_2 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      + Age:Creatinine_max # creatinine generally increases with age
                     , data=icu_patients_df1, family="binomial")

# finalICU_glm_3 = finalICU_glm + Age:Temp_min
finalICU_glm_3 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      + Age:Temp_min # low temp more often associated with illness in the elderly e.g. cold sepsis
                     , data=icu_patients_df1, family="binomial")

# finalICU_glm_4 = finalICU_glm + Age:Weight_min
finalICU_glm_4 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      + Age:Weight_min # weight generally decreases with age
                     , data=icu_patients_df1, family="binomial")

# finalICU_glm_5 = finalICU_glm + Age:Albumin_min
finalICU_glm_5 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      Age:Albumin_min # albumin can decrease with age
                    , data=icu_patients_df1, family="binomial")

# finalICU_glm_6 = finalICU_glm + Gender:HCT_min
finalICU_glm_6 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      Gender:HCT_min # HCT can be lower in females than males
                    , data=icu_patients_df1, family="binomial")

# finalICU_glm_7 = finalICU_glm + PaO2_min:RespRate_max
finalICU_glm_7 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      PaO2_min:RespRate_max # PaO2 and resp rate are intrinsically related physiologically
                    , data=icu_patients_df1, family="binomial")

# finalICU_glm_8 = finalICU_glm + Age:ICUType
finalICU_glm_8 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      Age:ICUType # age is likely to be related to ICU type 
                                  # e.g. elderly more likely to have poor outcome after surgery requiring post-op ICU support
                    , data=icu_patients_df1, family="binomial")


# comparing models with anova
lapply(list(finalICU_glm_2, finalICU_glm_3, finalICU_glm_4, finalICU_glm_5,
            finalICU_glm_6, finalICU_glm_7, finalICU_glm_8), 
       function(x) {print(anova(finalICU_glm, x, test="Chisq"))} )
  # the effect of weight_min varied with age
  # the effect of ICUType varied with age
  # borderline -- the effect of resprate_max varied with PaO2_min

## feel free to add other interactions to test


# input the significant interaction terms into a model and examine output
finalICU_glm_9 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction terms
                      Age:Weight_min + Age:ICUType # effects that had a significant effect on the model with anova
                    , data=icu_patients_df1, family="binomial")

summary(finalICU_glm_9)
# the AIC is slightly lower than finalICU_glm

## the effects of the interactions have significance but the ORs are close to 1 with narrow CIs -- perhaps not very clinically informative (i.e. the odds are essentially 1 i.e. equal)
options(scipen=999)
exp(coef(finalICU_glm_9))
exp(confint(finalICU_glm_9))

# TO BE DELETD FROM ABOVE TO HERE
#################################################################################
```

Testing the modified poisson regression, as the outcome is 14% in this data (>10% - common)

```{r task 1.5_test-poisson}

# test using modified poisson regression for more common outcomes on the same covariates as above

finalICU_glm_poisson <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                        
                      # baseline demographics should be included even if not significant
                      Gender + Length_of_stay + Weight_min + 
                      SOFA + # an indicator of how well SOFA score determines mortality independent to its components
                      
                      # other clinical relevance
                      Albumin_min + # low albumin indicates malnutrition or liver failure
                      Glucose_max + # hyperglycaemia is a stress response
                      HCT_min + # low HCT = anaemia
                      HR_max + # tachycardia may indicate septic shock / inflammation
                      PaO2_min + # hypoxia = inadequate organ perfusion/oxygenation
                      PaCO2_min + #hypercapnia = respiratory / ventilation failure
                      pH_min + # indicates acidaemia / inadequate organ perfusion
                      RespRate_max + # indicates respiratory failure
                      TroponinT_max + # indicates myocardial damage
                      WBC_max # indicates infection
                      
                    , data=icu_patients_df1, family="poisson"(link="log"))

summary(finalICU_glm_poisson)

# fewer significant variables (likely as CI can be wider in poisson)
# but the variables that are significant were also significant in the logistic model

# examine ORs from logistic regression
options(scipen=999) # turn off scientific notation
exp(coef(finalICU_glm))

# examine RRs from logistic regression
exp(coef(finalICU_glm_poisson))

# the ORs and RRs appear very similar --> check the actual differences
exp(coef(finalICU_glm))-exp(coef(finalICU_glm_poisson))
# the intercept is very different (by 82000!) - not sure how to interpret that. the other estimates are very similar

# perhaps the logistic model is therefore justified? just need to be careful in interpretation using 'odds' rather than 'risk'
```


6. For your final model, present a set of diagnostic statistics and/or charts and comment on them.

```{r task1.6}
library(magrittr)
library(dplyr)

# icu_patients_df1
# lots of missing data in:
# Survival, ABP, NIBP variables
# some missing data in SAPS1 and Weight - correlates with GLM full model missing data
for(i in 1:length(colnames(icu_patients_df1))){
  print(c(i,colnames(icu_patients_df1[i]), sum(is.na(icu_patients_df1[i]))))
}



# remove observations with missing values from the data frame, 
# because they are automatically dropped by glm()

# remove the survival, ABP, some of the BP, height columns first
icu_patients_df1_nm <- icu_patients_df1[, -c(5,34:36,53,73:81, 100:102)]
icu_patients_df1_nm <- na.omit(icu_patients_df1_nm)


### Goodness of fit using bins df1 ###

# add predicted probabilities to the data frame
icu_patients_df1_nm %>% mutate(predprob=predict(finalICU_glm, type="response"),
                   linpred=predict(finalICU_glm)) %>%
# group the data into bins based on the linear predictor fitted values
group_by(cut(linpred, breaks=unique(quantile(linpred, (1:50)/51)))) %>%
# summarise by bin
summarise(death_bin=sum(in_hospital_death), predprob_bin=mean(predprob), n_bin=n()) %>%
# add the standard error of the mean predicted probaility for each bin
mutate(se_predprob_bin=sqrt(predprob_bin*(1 - predprob_bin)/n_bin)) %>%
# plot it with 95% confidence interval bars
ggplot(aes(x=predprob_bin, 
           y=death_bin/n_bin, 
           ymin=death_bin/n_bin - 1.96*se_predprob_bin,
           ymax=death_bin/n_bin + 1.96*se_predprob_bin)) +
  geom_point() + geom_linerange(colour="orange", alpha=0.4) +
  geom_abline(intercept=0, slope=1) + 
  labs(x="Predicted probability (binned)",
       y="Observed proportion (in each bin)")
# the ideal calibration line fits within most of the dots and their 95% CI

### Goodness of fit using Hosmer Lemeshow stat ###

icu_patients_df1_nm %>% mutate(predprob=predict(finalICU_glm, type="response"),
                   linpred=predict(finalICU_glm)) %>%
group_by(cut(linpred, breaks=unique(quantile(linpred, (1:50)/51)))) %>%
summarise(death_bin=sum(in_hospital_death), predprob_bin=mean(predprob), n_bin=n()) %>%
mutate(se_predprob_bin=sqrt(predprob_bin*(1 - predprob_bin)/n_bin)) -> hl_df

hl_stat <- with(hl_df, sum( (death_bin - n_bin*predprob_bin)^2 /
                            (n_bin* predprob_bin*(1 - predprob_bin))))
hl <- c(hosmer_lemeshow_stat=hl_stat, hl_degrees_freedom=nrow(hl_df) - 1)
hl

# calculate p-value
c(p_val=1 - pchisq(hl[1], hl[2])) # the p value here is not statistically significant, indicating no lack of fit


### Brier score ###

get_brier <- function(model){
  predprob <- predict(model, type="response")
  Brier_score <- mean((predprob - icu_patients_df1_nm$in_hospital_death)^2)
  return(Brier_score)
}

get_brier(finalICU_glm)
get_brier(minmaxdiffICU_glm)
get_brier(step_minmaxdiffICU_glm)

# the final model has the lowest brier score -> lower score is better fit



### trying to fit our model to icu_patients_df0 data ###

# icu_patients_df0
# alot of missing data here also!
for(i in 1:length(colnames(icu_patients_df0))){
  print(c(i,colnames(icu_patients_df0[i]), sum(is.na(icu_patients_df0[i]))))
}

# remove columns with too much missing data
# arbitrary selection of >200
# albumin, ALP, ALT, AST, bilirubin, cholesterol, diasABP, FiO2, lactate, MAP, NIDiasABP, NIMAP, NISSysABP
# pH, RespRate, SaO2, Troponin

icu_patients_df0_nm <- icu_patients_df0[, -c(10:24, 28:30, 34:39, 61:66, 73:90, 94:102, 106:111 )]
icu_patients_df0_nm <- na.omit(icu_patients_df0_nm)

# ***haven't worked out how to fit our model into df0 data!!!***

```


7. Write a paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation.



#####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 


# Task 2 (15 marks)

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately explains or predicts the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a series of models, maybe three or four, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. Aim for between five and ten predictor variables (slightly more or fewer is OK). It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at least comment on the possible impact of what your diagnostics show). Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.


### Hints

1. Select an initial subset of explanatory variables that you will use to predict survival. Justify your choice.

```{r task2.1}
#Survival anlaysis Data set up
library(survival)
library(eha)
library(stringi)
library(bshazard)
library(survminer)

#Available variables
head(icu_patients_df1)

```

**Selecting an initial subset of explanatory variables:

To select a subset of explanatory variables our group of investigators will examine the SAPS1 score and the SOFA score included in the dataset in more detail to ascertain the variables that might be logically associated with increased mortality and poor survival. We will also assess the APACHE score which is commonly used in ICU risk predcition models.

`SAPS1` - Simplified Acute Physiology Score is a measure of the severity of disease for patients admitted to ICU. The following measures increases the SAPS1 score:

  * Advanced Age
  * Low and high Heart Rate
  * Low and high Systolic Blood Pressure
  * High Temperature
  * Low Glasgow Coma Scale (However it is most meaningful to use the highest GCS score available for prognostication)
  * Mechanical Ventilation or CPAP
  * High PaO2/ FiO2 ratio (It is likely that highes FiO2 is administered during lowest PaO2)
  * Low Urine Output
  * High Blood Urea Nitrogen
  * Low or High Sodium
  * Low or high Potassium
  * Low Bicarbonate
  * High Bilirubin
  * Low or High White Blood Cell
  * Chronic diseases
  * Type of admission (ie ICU Type)

*`SOFA` - sequential organ failure assessment is a predictor of ICU mortality. The following measures increase the SOFA score:
  * Elevated PaO2/ FiO2 ratio- 
  * Reduced GCS - Nervous system
  * Reduced MAP - Cardiovascular system
  * Administration of vasopressors - Cardiovascular system
  * High Bilirubin - Liver
  * Low Platelets - Coagulation
  * High Creatinine - Kidneys
  * Low Urine - Kidneys
  
  
*The `APACHE` score is commonly used validated risk score for ICU risk prediction. The variables that increase the APACHE score include:

  * Advanced Age
  * High or Low Temperature
  * High or Low MAP
  * High or Low HR
  * High or Low Respiratory Rate
  * High PaO2/FiO2 ratio
  * High or Low pH
  * High or Low Na
  * High or Low K
  * High Creatinine
  * High or low HCT
  * High or Low WBC


* For our analysis, we will include variables that will increase SOFA, SAPS or APACHE scores. 
        eg: increased BUN and reduced HCO3 will increase the SAPS score, therfore we will include BUN max(but not BUN_min and BUN_diff) and 
        HCO3_min (but not HCO3_max and HCO3_diff). Where both extremes of a variable will increase the risk score, both min and max variables will 
        be included.
        
* Other factors known to be associated with morbidity/ mortality not included in risk scores: 
  * Height/ weight - Body composition/ BMI is associated with mortality and survival
  * Gender - Male gender associated with worse outcomes
  * Glucose - high and low Glucose levels are associated with pathology
  * Troponin T and I - high troponin results(cardiac biomarkers) associated with morbidity and mortality
  * Lactate - elevated lactate is associated with poor organ perfusion and ICU morbidity/ mortality
  * Albumin - reduced albumin is associated with poor clinical outcomes
        
***BELOW IS A LIST OF THE VARIABLES TO BE INCLUDED:***
DEMOGRAPHIC VARAIBLES:
  * Age
  * Gender
  * ICU Type
  * Height 
  * Weight_max
  
CLINICAL VARIABLES:
  * Albumin_min
  * Bilirubin_max 
  * BUN_max
  * Creatinine_max  
  * GCS_min
  * Glucose_min and Glucose_max
  * HCO3_min
  * HR_min and HR_max 
  * K_min K_max
  * Lactate_max
  * MAP_min  
  * Na_min and Na_max 
  * NISysABP_min and NISysABP_max 
  * Platelets_min
  * FiO2_max and PaO2_min - included as PFratio: PaO2_min/ FiO2_max
  * pH_min and pH_max
  * RespRate_min and RespRate_max
  * Temp_min and Temp_max
  * TroponinI_max
  * TroponinT_max
  * Urine_min 
  * WBC_min and WBC_max


2. Conduct basic exploratory data analysis on your variables of choice.
```{r task 2.2.1}

# Outcome variables
unique_icu = unique(subset(icu_patients_df1, select = c(RecordID)))
dim(unique_icu) # There are 2061 unique individuals
table(icu_patients_df1$Status) #773 censored out of 2061 observations

# Plot KM survival curve (non-parametric)
ICU.fit <- survfit( Surv(Days, Status) ~ 1, data = icu_patients_df1) 
print(ICU.fit, print.rmean = TRUE)
summary(ICU.fit)
plot(ICU.fit, main = 'Kaplan-Meier estimate of survival function', xlab = 'Length of survival (in days)')

# plotting Nelson-Aalen estimate (non-parametric)
plot(ICU.fit, fun="cumhaz", main = "Nelson-Aalen estimate of cumulative hazard function", xlab = 'Length of survival (in days)')

```

There were 773 deaths (out of 2061 participants) during follow-up.The median follow-up time cannot be determined as the survival rate has not yet dropped to 50% survival at the end of the available data. The cumulative hazard rate (as shown in the Nelson Aalen plot)  reaches 47% by the end of the available data.

```{r task 2.2.2, fig.width=20, fig.height=60} 

# Display frequencies for categorical explanatory variables
table(icu_patients_df1$Gender)
table(icu_patients_df1$ICUType)


# Display counts, histograms, median and IQRs for continuous explanatory variables

#################################################################################
### CODE COPIED TO TASK 1
# Create PFratio variable:
# icu_patients_df1$PFratio<-icu_patients_df1$PaO2_min/icu_patients_df1$FiO2_max
### CODE COPIED TO TASK 1
#################################################################################

# Write a function for continuous variable EDA output
cont_eda <- function(variable){
    print(paste(variable,'EDA:'))
  
    na_rm <- na.omit(icu_patients_df1[,variable])
    print(paste('Number of non-missing values:',length(na_rm))) # number of non-missing values
    print(paste('Number of missing values:',sum(is.na(icu_patients_df1[,variable])))) # number of missing values
  
    print(quantile(icu_patients_df1[,variable], na.rm=TRUE))
    hist(icu_patients_df1[,variable], breaks=20, xlab=variable, main=paste('Histogram of',variable))
}

#################################################################################
### CODE COPIED TO TASK 1
# Loop through the continuous variables from the chosen list of variables to explore and pass them to the EDA function
# cont_vars <- c('Age', 'Height', 'Weight_max', 'Albumin_min', 'Bilirubin_max', 
#                'BUN_max', 'Creatinine_max', 'GCS_min', 'Glucose_min', 
#                'Glucose_max', 'HCO3_min', 'HR_min', 'HR_max', 'K_min', 'K_max', 
#                'Lactate_max', 'MAP_min', 'Na_min', 'Na_max', 'NISysABP_min', 
#                'NISysABP_max', 'Platelets_min', 'PFratio', 'pH_min', 'pH_max', 
#                'RespRate_min', 'RespRate_max', 'Temp_min', 'Temp_max', 
#                'TroponinI_max', 'TroponinT_max', 'Urine_min', 'WBC_min', 'WBC_max')
### CODE COPIED TO TASK 1
#################################################################################

par(mfrow=c(12,3)) # set the layout of the histograms in 12 row x 3 column grid
for(i in 1:length(cont_vars)){
  cont_eda(cont_vars[i])
}

```
*** 
needs to be updated: 
***

** EDA Findings

* There are 2061 unique individuals in the dataset. Of these, 913 are female (44%) and 1148 are male (56%).
* Medical ICU accounted for 38% of individuals, 26% in Surgical ICU, 24% in Cardiac Surgery recovery Unit and 14% in the Coronary Care unit.
* The median length of stay in hospital is 10 days with an IQ range of 11 days. There are 25 missing values.
* The median age is 67 with an IQ range of 26.
* The median height is 170.2 cm with IQ range of 15.2cm. There are 1069 (52%) with a valid measurements.
* The median minimum weight is 77.7 kg with a IQ range of 26.95. The median maximum weight is 80kg (slightly higher) with an IQ range of 28.55. The median difference in weight (max to mean over 24 hrs) is 14.7 kg with an IQ range of 17.2 kg. Some outliers or measurement error looks present with a max difference on 149kg.

*************************
* The median minimum Bilirubin is 0.6 with an IQ range of 0.7. The median maximum Bilirubin is 0.7 with an IQ range of 0.9. The median difference in Bilirubin is 1.36 with an IQ range of 0.4.
* The median minimum Creatinine is 0.9 with an IQ range of 0.6. The median maximum Creatinine is 1.0 with an IQ range of 0.7. The median difference in Creatinine is 0.53 with an IQ range of 0.4.

... fill out the rest....

```{r task 2.2.3}
#Plot the Kaplan-Meier survival curves by all categorical variables in the data

#Gender
ICU.gender.fit <- survfit( Surv(Days, Status) ~ as.factor(Gender), data = icu_patients_df1) 
print(ICU.gender.fit, print.rmean = TRUE)
plot(ICU.gender.fit, col=c("blue", "red"), main = 'Kaplan-Meier estimate of survival function', xlab = 'Length of survival (in days)')
legend("bottomleft", legend=c("Female", "Male"),col=c("blue","red"), lty=1:1,cex=1)

#ICUType
ICU.type.fit <- survfit( Surv(Days, Status) ~ as.factor(ICUType), data = icu_patients_df1) 
print(ICU.type.fit, print.rmean = TRUE)
plot(ICU.type.fit, col=c("blue", "red","purple","green"), main = 'Kaplan-Meier estimate of survival function', xlab = 'Length of survival (in days)')
legend("bottomleft", legend=c("Coronary Care Unit", "Cardiac Surgery Recovery Unit", "Medical ICU", "Surgical ICU"),col=c("blue","red","purple","green"), lty=1:1,cex=1)

```
Risk of mortality is different by both Gender and ICU Type - the hazard rates also look proportional.


3. Fit appropriate univariate Cox proportional hazards models.
```{r task2.3.1}

# Cox proportional models and Log Rank tests for the chosen variables
# Survival object = Surv(Days, Status)

# Gender
ICU.fitbyGender <- coxph( Surv(Days, Status) ~ as.factor(Gender), data = icu_patients_df1) 
summary(ICU.fitbyGender)

# ICU Type
ICU.fitbytype <- coxph( Surv(Days, Status) ~ as.factor(ICUType), data = icu_patients_df1) 
summary(ICU.fitbytype)

# Age
ICU.fitbyage <- coxph( Surv(Days, Status) ~ Age, data = icu_patients_df1) 
summary(ICU.fitbyage)

# Height
ICU.fitbyheight <- coxph( Surv(Days, Status) ~ Height, data = icu_patients_df1) 
summary(ICU.fitbyheight)

# Weight_max
ICU.fitbyweightmax <- coxph( Surv(Days, Status) ~ Weight_max, data = icu_patients_df1) 
summary(ICU.fitbyweightmax)

# Albumin_min
ICU.fitbyAlbuminmin <- coxph( Surv(Days, Status) ~ Albumin_min, data = icu_patients_df1) 
summary(ICU.fitbyAlbuminmin)

# Bilirubin_max
ICU.fitbyBilirubinmax <- coxph( Surv(Days, Status) ~ Bilirubin_max, data = icu_patients_df1) 
summary(ICU.fitbyBilirubinmax)

# BUN_max
ICU.fitbyBUNmax <- coxph( Surv(Days, Status) ~ BUN_max, data = icu_patients_df1) 
summary(ICU.fitbyBUNmax)

# Creatinine_max
ICU.fitbyCreatininemax <- coxph( Surv(Days, Status) ~ Creatinine_max, data = icu_patients_df1) 
summary(ICU.fitbyCreatininemax)

# GCS_min
ICU.fitbyGCSmin <- coxph( Surv(Days, Status) ~ GCS_min, data = icu_patients_df1) 
summary(ICU.fitbyGCSmin)

# Glucose - min & max
ICU.fitbyGlucosemin <- coxph( Surv(Days, Status) ~ Glucose_min, data = icu_patients_df1) 
summary(ICU.fitbyGlucosemin)
ICU.fitbyGlucosemax <- coxph( Surv(Days, Status) ~ Glucose_max, data = icu_patients_df1) 
summary(ICU.fitbyGlucosemax)

# HCO3_min
ICU.fitbyHCO3min <- coxph( Surv(Days, Status) ~ HCO3_min, data = icu_patients_df1) 
summary(ICU.fitbyHCO3min)

# HR - min & max
ICU.fitbyHRmin <- coxph( Surv(Days, Status) ~ HR_min, data = icu_patients_df1) 
summary(ICU.fitbyHRmin)
ICU.fitbyHRmax <- coxph( Surv(Days, Status) ~ HR_max, data = icu_patients_df1) 
summary(ICU.fitbyHRmax)

# K - min & max
ICU.fitbyKmin <- coxph( Surv(Days, Status) ~ K_min, data = icu_patients_df1) 
summary(ICU.fitbyKmin)
ICU.fitbyKmax <- coxph( Surv(Days, Status) ~ K_max, data = icu_patients_df1) 
summary(ICU.fitbyKmax)

# Lactate_max
ICU.fitbyLactatemax <- coxph( Surv(Days, Status) ~ Lactate_max, data = icu_patients_df1) 
summary(ICU.fitbyLactatemax)

# MAP_min
ICU.fitbyMAPmin <- coxph( Surv(Days, Status) ~ MAP_min, data = icu_patients_df1) 
summary(ICU.fitbyMAPmin)

# Na - min & max
ICU.fitbyNamin <- coxph( Surv(Days, Status) ~ Na_min, data = icu_patients_df1) 
summary(ICU.fitbyNamin)
ICU.fitbyNamax <- coxph( Surv(Days, Status) ~ Na_max, data = icu_patients_df1) 
summary(ICU.fitbyNamax)

# NISysABP - min & max
ICU.fitbyNISysABPmin <- coxph( Surv(Days, Status) ~ NISysABP_min, data = icu_patients_df1) 
summary(ICU.fitbyNISysABPmin)
ICU.fitbyNISysABPmax <- coxph( Surv(Days, Status) ~ NISysABP_max, data = icu_patients_df1) 
summary(ICU.fitbyNISysABPmax)

# Platelets_min
ICU.fitbyPlateletsmin <- coxph( Surv(Days, Status) ~ Platelets_min, data = icu_patients_df1) 
summary(ICU.fitbyPlateletsmin)

# PFratio (PaO2_min/FiO2_max)
ICU.fitbyPFratio <- coxph( Surv(Days, Status) ~ PFratio, data = icu_patients_df1) 
summary(ICU.fitbyPFratio)

# pH - min & max
ICU.fitbypHmin <- coxph( Surv(Days, Status) ~ pH_min, data = icu_patients_df1) 
summary(ICU.fitbypHmin)
ICU.fitbypHmax <- coxph( Surv(Days, Status) ~ pH_max, data = icu_patients_df1) 
summary(ICU.fitbypHmax)

# RespRate - min & max
ICU.fitbyRespRatemin <- coxph( Surv(Days, Status) ~ RespRate_min, data = icu_patients_df1) 
summary(ICU.fitbyRespRatemin)
ICU.fitbyRespRatemax <- coxph( Surv(Days, Status) ~ RespRate_max, data = icu_patients_df1) 
summary(ICU.fitbyRespRatemax)

# Temp - min & max
ICU.fitbyTempmin <- coxph( Surv(Days, Status) ~ Temp_min, data = icu_patients_df1) 
summary(ICU.fitbyTempmin)
ICU.fitbyTempmax <- coxph( Surv(Days, Status) ~ Temp_max, data = icu_patients_df1) 
summary(ICU.fitbyTempmax)

# Troponin_max (I and T assays)
ICU.fitbyTroponinImax <- coxph( Surv(Days, Status) ~ TroponinI_max, data = icu_patients_df1) 
summary(ICU.fitbyTroponinImax)
ICU.fitbyTroponinTmax <- coxph( Surv(Days, Status) ~ TroponinT_max, data = icu_patients_df1) 
summary(ICU.fitbyTroponinTmax)

# Urine_min
ICU.fitbyUrinemin <- coxph( Surv(Days, Status) ~ Urine_min, data = icu_patients_df1) 
summary(ICU.fitbyUrinemin)

# WBC - min & max
ICU.fitbyWBCmin <- coxph( Surv(Days, Status) ~ WBC_min, data = icu_patients_df1) 
summary(ICU.fitbyWBCmin)
ICU.fitbyWBCmax <- coxph( Surv(Days, Status) ~ WBC_max, data = icu_patients_df1) 
summary(ICU.fitbyWBCmax)


```
**Univariable Cox model interpretation by Variable**
* `Gender` - non-significant log-rank test (p-value = 0.06), means that the null hypothesis of no difference in survival between genders is not rejected with a conclusion that survival does not significantly differ by gender.
* `ICUType` - significant log-rank test (p-value close to 0), means that the null hypothesis is rejected with a conclusion that survival significantly differs by each ICU Type. Note that, hazard rate for those in Medical ICU is not statistically significantly different for those in Coronary Care Unit.
* `Length_of_stay` - significant log-rank test (p-value close to 0), means that the null hypothesis is rejected with a conclusion that survival significantly differs by length of stay in hospital.For every additional day in hospital, the risk of mortality increases by approximately 1%.
* `Age` - significant log-rank test (p-value close to 0), means that the null hypothesis is rejected with a conclusion that survival significantly differs by individual's age. For every year older in age, the risk ofmortality increases by approcimately 3%.
* `Height` - non-significant log-rank test (p-value = 0.1), means that the null hypothesis of no difference in survival for varying heights is not rejected with a conclusion that survival does not significantly differ by height.
* Weight - the minimum, maximum and difference in weights as predictors result in significant log-rank tests indicating that the null hypothesis is rejected with a conclusion that survival significantly differs by weight. For every additional kilogram, the risk of mortality reduces by approximately 0.5-1%. Perhaps the use of a centred variable may make it easier to interpret.
* `SAPS1` - significant log-rank test (p-value close to 0), means that the null hypothesis is rejected with a conclusion that survival significantly differs by SAPS1 score. For every additional SAPS1 score, the risk of mortality increases by approximately 7%.
* `SOFA` - significant log-rank test (p-value close to 0), means that the null hypothesis is rejected with a conclusion that survival significantly differs by SOFA score. For every additional SOFA score, the risk of mortality increases by approximately 6%.
* Significant clinical measures are:
  * Bilirubin
  * Creatinine
  * FiO2 - maximum and difference from mean are significant
  * GCS - maximum and difference from mean are significant
  * HCO3 - difference from mean is highly significant, maximum and mean also significant
  * HR - difference from mean is significant
  * K - maximum and difference from mean are significant
  * MAP - minimum and difference from mean are significant
  * Na - minimum and difference from mean are significant
  * NISysABP  
  * PaO2
  * SysABP - maximum and difference from mean are significant
  * Temp 
  * Urine
  * WBC - difference from mean is significant
  
  
***
Updated list of significant log-ranks (5 May):
ICUType, Age, Weight_max, Albumin_min, Bilirubin_max, BUN_max, Creatinine_max, Glucose_max, HCO3_min, K_max, Lactate_max, MAP_min, Na_min, NISysABP_min, NISysABP_max, pH_min, pH_max, RespRate_min, RespRate_max, Temp_min, Temp_max, TroponinT_max, Urine_min
***


4. Fit an appropriate series of multivariable Cox proportional hazards models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.
```{r task 2.4.1}

#################################################################################
### CODE COPIED TO TASK 1
## Create a dataset without missing or invalid data to use to build the model ##
## in order to remain consistent and allow comparisons between models to be made ##


# # Check counts of missing data in each variable
# for(i in 1:length(colnames(icu_patients_df1))){
#   print(c(i,colnames(icu_patients_df1[i]), sum(is.na(icu_patients_df1[i]))))
# }
# ## Result: of the variables chosen to explore for the survival model, large amounts of missing data in:
# ##         Height (992), NISysABP_min (453), NISysABP_max (453), Weight_max (146)
# 
# ## Decision: include Weight_max; remove Height, NISysABP_min, NISysABP_max
# 
# 
# # Check counts of negative data (noted some -1 values) in each variable
# for(i in 1:length(colnames(icu_patients_df1))){
#   print(c(i,colnames(icu_patients_df1[i]), sum(icu_patients_df1[i] < 0)))
# }
# ## Result: negative values in Length_of_stay and SOFA (not listed in initial choice of variables anyway)


# # Create a new dataset with the only non-missing data from list of initial variables chosen
# # (excluding those with very high missingness i.e. Height, NISysABP_min, NISysABP_max)
# nm_icu_model_df1 <- na.omit(subset(icu_patients_df1, 
#                                    select=c(Days, Status, # the survival object variables
#                                             RecordID, # keep record id for reference if needed
#                                             in_hospital_death, # for task 1
#                                             Age, Gender, ICUType, Weight_max,
#                                             Albumin_min, Bilirubin_max,
#                                             BUN_max, Creatinine_max, 
#                                             GCS_max, Glucose_min, Glucose_max, 
#                                             HCO3_min, HR_min, HR_max, K_min, 
#                                             K_max, Lactate_max, MAP_min, Na_min,
#                                             Na_max, Platelets_min, PFratio, pH_min,
#                                             pH_max, RespRate_min, RespRate_max,
#                                             Temp_min, Temp_max, TroponinT_max, 
#                                             TroponinI_max, Urine_min, WBC_min, WBC_max)))

### CODE COPIED TO TASK 1
#################################################################################

```

```{r task 2.4.2 }
## Fitting multivariable models ##


# Create a function to calculate AIC
calc_aic <- function(model){
  # AIC = 2*k-2*logL (where k=df and df=number of coefficients in the model)
  AIC <- 2*length(model$coefficients)-2*model$loglik[2]
}


# Full model using all listed initial variables (excluding those with high missingness)
ICU.mv_full <- coxph(Surv(Days, Status) ~ 
                    Age + Gender + ICUType + Weight_max + Albumin_min + Bilirubin_max +
                    BUN_max + Creatinine_max + GCS_max + Glucose_min + Glucose_max + 
                    HCO3_min + HR_min + HR_max + K_min + K_max + Lactate_max + MAP_min + 
                    Na_min + Na_max + Platelets_min + PFratio + pH_min + pH_max + 
                    RespRate_min + RespRate_max + Temp_min + Temp_max + TroponinT_max + 
                    TroponinI_max + Urine_min + WBC_min + WBC_max,
                    data = nm_icu_model_df1)
summary(ICU.mv_full)

# Calculate full model AIC
AIC.mv_full <- calc_aic(ICU.mv_full)
AIC.mv_full #10136


# 1st reduced model using all variables with significant log-rank tests
ICU.mv_reduced1 <- coxph(Surv(Days, Status) ~
                        Age + ICUType + Weight_max + Albumin_min + Bilirubin_max +
                        BUN_max + Creatinine_max + Glucose_max + HCO3_min + 
                        K_max + Lactate_max + MAP_min + Na_min + pH_min + 
                        pH_max + RespRate_min + RespRate_max + Temp_min + 
                        Temp_max + TroponinT_max + Urine_min,
                        data = nm_icu_model_df1)
summary(ICU.mv_reduced1)

# Calculate 1st reduced model AIC
AIC.mv_reduced1 <- calc_aic(ICU.mv_reduced1)
AIC.mv_reduced1 #10178


# 2nd reduced model using all variables significant (using cut off p < 0.1) in ICU.mv_reduced1
# (note using p < 0.1 gained better results than p < 0.05 as a cut off)
ICU.mv_reduced2 <- coxph(Surv(Days, Status) ~
                        Age + ICUType + Albumin_min + Bilirubin_max + BUN_max + 
                        HCO3_min + Lactate_max + Na_min + pH_min + 
                        RespRate_max + Urine_min,
                        data = nm_icu_model_df1)
summary(ICU.mv_reduced2)

# Calculate 2nd reduced model AIC
AIC.mv_reduced2 <- calc_aic(ICU.mv_reduced2)
AIC.mv_reduced2 #10171


# 3rd reduced model by using step() function on the full model (which had the lowest AIC so far)
ICU.mv_reduced3 <- step(ICU.mv_full, trace=1)
summary(ICU.mv_reduced3)
## Interestingly: GCS_max, HR_min & Na_max have worked their way back in (not significant on log-rank)

# Calculate 3rd reduced model AIC
AIC.mv_reduced3 <- calc_aic(ICU.mv_reduced3)
AIC.mv_reduced3 #10113


# 4th reduced model using significant variables (using cut off p < 0.1) from ICU.mv_reduced3 
ICU.mv_reduced4 <- coxph(Surv(Days, Status) ~
                        Age + ICUType + Albumin_min + Bilirubin_max + BUN_max + 
                        GCS_max + HCO3_min + HR_min + Lactate_max + Na_max + 
                        pH_min + Temp_max + Urine_min,
                        data = nm_icu_model_df1)
summary(ICU.mv_reduced4)

# Calculate 4th reduced model AIC
AIC.mv_reduced4 <- calc_aic(ICU.mv_reduced4)
AIC.mv_reduced4 #10112


# Comparing models with LRT
lapply(list(ICU.mv_reduced1, ICU.mv_reduced2, ICU.mv_reduced3, ICU.mv_reduced4), 
       function(reduced) {print(anova(ICU.mv_full, reduced))} )
## Results: reduced1 and reduced2 - reject the null hypothesis that the reduced models are better (they are worse)
##          reduced3 and reduced4 - DONT reject the null hypothesis 
##                                    --> therefore the reduced models are better than the full model (matches our AICs)


# Print the AICs all together to review
aic_output <- c(AIC.mv_full, AIC.mv_reduced1, AIC.mv_reduced2, AIC.mv_reduced3, AIC.mv_reduced4)
names(aic_output) <- c('Full AIC', 'Reduced 1 AIC', 'Reduced 2 AIC', 'Reduced 3 AIC', 'Reduced 4 AIC')
print(aic_output)

## Decision: use ICU.mv_reduced4 as the provisional final model (lowest AIC and non-significant LRT)
## Note: the full model still has the largest (best) maximised log-likelihood, but we choose the simplified model for parsimony

```
**commentary** ...


```{r task 2.4.3}
## Testing assumptions ##

# Testing for proportional hazards assumption of ICU.mv_reduced4 using cox.zph()
cox.zph(ICU.mv_reduced4, terms=FALSE)
## Result: statistically significant global test, therefore the proportional hazards model is violated
##         (the variables that violate are: ICUType, Albumin_min, Bilirubin_max, GCS_max, HCO3_min, HR_min, Lactate_max)


# Including time x covariate interactions to fix proportional hazards for problematic variables

# Split the dataset at 90 days (~ 3 months)
# Suspect there may be some systematic differences in patients who survive less than or greater than 3 months after ICU admission
ICU.split <- survSplit(Surv(Days, Status) ~ ., data = nm_icu_model_df1, cut=c(90), episode= "tgroup", id="id2")
head(ICU.split)

# Fit the model with time x covariate interactions
ICU.mv_reduced4.split <- coxph(Surv(Days, Status) ~
                                Age + ICUType:strata(tgroup) + 
                                Albumin_min:strata(tgroup) + 
                                Bilirubin_max:strata(tgroup) + BUN_max + 
                                GCS_max:strata(tgroup) + HCO3_min:strata(tgroup) + 
                                HR_min:strata(tgroup) + 
                                Lactate_max:strata(tgroup) + Na_max + pH_min + 
                                Temp_max + Urine_min,
                                data = ICU.split)
summary(ICU.mv_reduced4.split)

# evaluating the proportional hazards assumption again, for the model with time x covariate interactions
cox.zph(ICU.mv_reduced4.split, terms=FALSE)
## Result: the global test is now insignificant (p = 0.07)


# Checking Linearity by observing Martingale residuals

# Refit the chosen model with any factor variables re-coded as numeric 
# to allow the ggcoxfunctional() function to work
ICU.mv_reduced4.nofactor <- coxph(Surv(Days, Status) ~
                                  Age + as.numeric(ICUType) + Albumin_min + Bilirubin_max + BUN_max + 
                                  GCS_max + HCO3_min + HR_min + Lactate_max + Na_max + 
                                  pH_min + Temp_max + Urine_min,
                                  data = nm_icu_model_df1)
ggcoxfunctional(ICU.mv_reduced4.nofactor, nm_icu_model_df1)
## Result: they don't look particularly linear... especially with laboratory values very far from the reference ranges 
##         (likely few observations in this range / potential outliers)


# Check linearity of the model as a whole
ggcoxdiagnostics(ICU.mv_reduced4, type = "martingale", linear.predictions = FALSE, ggtheme = theme_bw()) 
## Result: appears reasonably linear with with 2 large negative outliers 
##         (large negative interpretation = 'lived too long')

# Examine the observations with very large negative residuals (< -3)
resid(ICU.mv_reduced4)[resid(ICU.mv_reduced4) < -3]
icu_patients_df1[c(1511,1929),]
## Interpretation: looks like they were relatively elderly with long lengths of stay
##                - one had low GCS values/high SAPS1/high lactate
##                - the other had high bilirubin/deranged LFTs/high lactate

## Decision: remove these outliers and re-fit the model to the dataset excluding these observations -->

# Check the RecordIDs match up with the correct data in the non-missing, split dataset
ICU.split[(ICU.split$RecordID == 136398 | ICU.split$RecordID == 137433),]

# Remove these observations and save as new dataset
ICU.split_noutliers <- ICU.split[!(ICU.split$RecordID %in% c(136398, 137433)),]

# Refit the split model to the new dataset
ICU.mv_reduced4.split.noutliers <- coxph(Surv(Days, Status) ~
                                          Age + ICUType:strata(tgroup) + 
                                          Albumin_min:strata(tgroup) + 
                                          Bilirubin_max:strata(tgroup) + BUN_max + 
                                          GCS_max:strata(tgroup) + HCO3_min:strata(tgroup) + 
                                          HR_min:strata(tgroup) + 
                                          Lactate_max:strata(tgroup) + Na_max + pH_min + 
                                          Temp_max + Urine_min,
                                          data = ICU.split_noutliers)
summary(ICU.mv_reduced4.split.noutliers)

# Calculate the split/no outlier model AIC
AIC.mv_reduced4.split.noutliers <- calc_aic(ICU.mv_reduced4.split.noutliers)
AIC.mv_reduced4.split.noutliers #10057 -- improvement

## Decision: use the 4th reduced model, split at time 3 months (90 days) on the split dataset with the outliers removed as the final dataset

```

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.
```{r task2.5}

ICU.final.cox <- coxph(Surv(Days, Status) ~
                         Age + ICUType:strata(tgroup) + 
                         Albumin_min:strata(tgroup) + 
                         Bilirubin_max:strata(tgroup) + BUN_max + 
                         GCS_max:strata(tgroup) + HCO3_min:strata(tgroup) + 
                         HR_min:strata(tgroup) + Lactate_max:strata(tgroup) + 
                         Na_max + pH_min + Temp_max + Urine_min,
                         data = ICU.split_noutliers)
summary(ICU.final.cox)

```

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them. 
```{r task2.6}


```

7. Write a very brief paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation. 

####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 



## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works, and then submit via the drop box in OpenLearning.

## Submit your assignment

When you have finished, and are satisfied with your assignment solutions, and this file knits without errors and the output looks the way you want, then you should submit via the drop box in OpenLearning.

### Problems?

If you encounter problems with any part of the process described above, please contact the course convenor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assignment is due.


### Additional Information

Each task attracts the indicated number of marks (out of a total of 30 marks for the assignment). The instructions are deliberately open-ended and less prescriptive than the individual assignments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks and gain full marks, you only need to replicate or repeat the steps covered in the course - if you do most or all of the things described in the revalant chapters of the HDAT9600 course, full marks will be awarded. 

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course convenor.
