---
title: "HDAT9600 Final Assignment"
subtitle: "Please see course outline / 'Announcements' for submission deadline"
author: "insert your team name here"
date: "insert date of completion here"
output: html_document
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)
```

## Instructions

This file (hdat9600_final_assignment.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final assignment. This assignment is assessed and will count for 30% of the total course marks. The assignment comprises two tasks worth 15 marks each. The first task will focus on logistic regression, and the second task will focus on survival analysis. There is no word limit, but a report of about 10 pages in length when printed (except that it will not be printed) is appropriate.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor are happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assignments for you!


## Data for this assignment

The data used for this assignment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assignment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. The original data has been modified and assembled to suit the purpose of this assignment. While not required for the purposes of this assignment, full details of the preparatory work can be found in the hdat9600_final_assignment_data_preparation file.

The dataframe consists of 120 variables, which are defined as follows:

#### Patient Descriptor Variables
<li> <em>RecordID:</em>            a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patientâ€™s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


#### Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


#### Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

<li> <em>SAPS-I score</em> [Simplified Acute Physiological Score (<a href="http://www.ncbi.nlm.nih.gov/pubmed/6499483"
target="_blank"><em>Le Gall et al., 1984</em></a>)]</li>
<li> <em>SOFA score</em> [Sequential Organ Failure Assessment (<a href="http://www.ncbi.nlm.nih.gov/pubmed/11594901"
target="_blank"><em>Ferreira et al., 2001</em></a>)]</li>

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

<li><a href="http://en.wikipedia.org/wiki/Human_serum_albumin" target="_blank">
<em>Albumin</em></a> (g/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Alkaline_phosphatase" target="_blank">
<em>ALP</em></a> [Alkaline phosphatase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Alanine_transaminase" target="_blank">
<em>ALT</em></a> [Alanine transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Aspartate_transaminase" target="_blank">
<em>AST</em></a> [Aspartate transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bilirubin" target="_blank">
<em>Bilirubin</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/BUN" target="_blank">
<em>BUN</em></a> [Blood urea nitrogen (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Cholesterol" target="_blank">
<em>Cholesterol</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine"
target="_blank">
<em>Creatinine</em></a> [Serum creatinine (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>DiasABP</em></a> [Invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/FIO2" target="_blank">
<em>FiO2</em></a> [Fractional inspired O<sub>2</sub> (0-1)]</li>
<li><a href="http://en.wikipedia.org/wiki/Glasgow_coma_score" target="_blank">
<em>GCS</em></a> [Glasgow Coma Score (3-15)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_glucose" target="_blank">
<em>Glucose</em></a> [Serum glucose (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics"
target="_blank">
<em>HCO3</em></a> [Serum bicarbonate (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hematocrit" target="_blank">
<em>HCT</em></a> [Hematocrit (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Heart_rate" target="_blank">
<em>HR</em></a> [Heart rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hypokalemia" target="_blank">
<em>K</em></a> [Serum potassium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Lactic_acid" target="_blank">
<em>Lactate</em></a> (mmol/L)</li>
<li><a href="http://en.wikipedia.org/wiki/Magnesium#Biological_role"
target="_blank">
<em>Mg</em></a> [Serum magnesium (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>MAP</em></a> [Invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mechanical_ventilation"
target="_blank">
<em>MechVent</em></a> [Mechanical ventilation respiration (0:false, or 1:true)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_sodium" target="_blank">
<em>Na</em></a> [Serum sodium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>NIDiasABP</em></a> [Non-invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>NIMAP</em></a> [Non-invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>NISysABP</em></a> [Non-invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaCO2</em></a> [partial pressure of arterial CO<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaO2</em></a> [Partial pressure of arterial O<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>pH</em></a> [Arterial pH (0-14)]</li>
<li><a href="http://en.wikipedia.org/wiki/Platelets" target="_blank">
<em>Platelets</em></a> (cells/nL)</li>
<li><a href="http://en.wikipedia.org/wiki/Respiratory_physiology" target="_blank">
<em>RespRate</em></a> [Respiration rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>SaO2</em></a> [O<sub>2</sub> saturation in hemoglobin (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>SysABP</em></a> [Invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Normal_human_body_temperature"
target="_blank">
<em>Temp</em></a> [Temperature (&deg;C)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropI</em></a> [Troponin-I (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropT</em></a> [Troponin-T (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Fluid_balance" target="_blank">
<em>Urine</em></a> [Urine output (mL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology" target="_blank">
<em>WBC</em></a> [White blood cell count (cells/nL)]</li>
<li>
<em>Weight</em> (kg)</li>


## Accessing the Data
The data frame can be loaded with the following code:

``` {r task-setup}

# Getting the path of your current open file
# Extra code to ensure this file imports birth.csv in local directory for everyone
library(rstudioapi)
current_path <- rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path ))

icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")

```
**Note:** icu_patients_df1 is an imputed (i.e. missing values are 'derived') version of icu_patients_df0.  This assignment does not concern the methods used for imputation.


# Task 1 (15 marks)

In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately explains or predicts the `in_hospital_death` variable as the outcome using a subset of the available predictor variables. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct or complete, but do you best). Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of diagnostic statistics and/or charts and comment on them. You don't need to do an exhaustive exploratory data analysis of all the variables in the data set, but you should examine those variables that you use in your model. Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


### Hints

1. Select an initial subset of explanatory variables that you will use to predict the risk of in-hospital death. Justify your choice.

``` {r task1.1}
summary(icu_patients_df1)
head(icu_patients_df1)

# Initial variables used to predict in-hospital death
# Based on background knowledge

# Albumin_min : low albumin assoc with malnutrition 
# Bilirubin_max: may indicate liver failure and also is included in SOFA scoring
# BUN_max : high urea assoc with renal impairment
# Creatinine_max : high creatinine assoc with renal impairment
# FiO2_max : high oxygen requirements indicate lung pathology
# GCS_min : low GCS indicates head pathology
# Glucose_min : both hypo and hyperglycaemia can contribute to mortality
# Glucose_max
# HCT_min : HCT or haemoglobin assoc with mortality
# HR_min : too high or too low HR can cause cardiac issues
# HR_max
# K_min : both hypo and hyperkalaemia can indicate pathology
# K_max
# Lactate_max : high lactate is a marker of inadequate organ perfusion
# Mg_min : low magnesium could result in arrhythmias
# MAP_min : hypoperfusion leads to morbidity
# MAP_max : hyperperfusion / dysregulation of circulation could lead to morbidity
# MAP_diff
# MechVent : mech vent associated with mortality
# Na_min : both hypo and hypernatremia can lead to brain oedema / damage / seizures
# Na_max
# PaCO2_min 
# PaCO2_max : hypercapnia can result from ventilatory failure
# PaO2_min : because oxygen is important
# pH_min : both acidaemia and alkaemia indicates systemic or renal pathology
# pH_max
# Platelets_min : low platelets indicate higher risk of bleeding
# RespRate_max : high RR is related to mortality
# SaO2_min : because oxygen is important
# Temp_min : hypothermia / hyperthermia may lead to morbiditiy
# Temp_max
# TropT_max : indicates myocardial injury
# Urine_min : low urine output indicates renal impairment
# WBC_max : presence of infection
# Weight : whether obesity has any contributing factors

# Non clinical variables:
# age
# gender
# height (and therefore BMI)
# ICUType
# Length_of_stay
# SAPS1
# ICUType

# Variables I am unsure of clinical significant:
# ALP / ALT / AST
# HCO3

```
2. Conduct basic exploratory data analysis on your variables of choice.

``` {r task1.2}

# add in BMI variable
# icu_patients_df1$BMI <- (icu_patients_df1$Weight_min) / (0.01*icu_patients_df1$Height)^2
# summary(icu_patients_df1$Weight_min)
# summary(icu_patients_df1$Height) #max height is 426.7cm!?
# summary(icu_patients_df1$BMI)
# BMI actually gives no meaningful data - remove this code!

# Basic EDA for each variable
library(ggplot2)
table(icu_patients_df1$in_hospital_death) #297 deaths out of 2016 observations = 14.4%

# Patients who died had lower albumin
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Albumin_min))+ geom_boxplot()

# Patients who died had higher bilirubin
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Bilirubin_max))+ geom_boxplot()

# Patients who died had higher urea
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = BUN_max))+ geom_boxplot()

# Patients who died had higher creatinine
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Creatinine_max))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = FiO2_max))+ geom_boxplot()

# Patients who died had lower GCS
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = GCS_min))+ geom_boxplot()

# Little to no difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Glucose_min))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Glucose_max))+ geom_boxplot()

# Patients who died had slightly lower HCT
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = HCT_min))+ geom_boxplot()

# Patients who died had slightly higher HR_min and HR_max
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = HR_min))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = HR_max))+ geom_boxplot()

# Little to no difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = K_min))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = K_max))+ geom_boxplot()

# Patients who died had slightly higher lactate
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Lactate_max))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Mg_min))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = MAP_min))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = MAP_max))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = MAP_diff))+ geom_boxplot()

# MechVent row was deleted from the data
# ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = MechVent))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Na_min))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Na_max))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = PaCO2_min))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = PaCO2_max))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = PaO2_min))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = pH_min))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = pH_max))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Platelets_min))+ geom_boxplot()

# Patients who died had higher RR
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = RespRate_max))+ geom_boxplot()

# More outliers in patients who survived with low saturations
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = SaO2_min))+ geom_boxplot()

# Patients who died had slightly lower tempeatures
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Temp_min))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Temp_max))+ geom_boxplot()

# Patients who died possibly slightly higher tropT
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = TroponinT_max))+ geom_boxplot()

# Patients who died had slightly less urine output
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Urine_min))+ geom_boxplot()

# Patients who died had slightly higher WBC
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = WBC_max))+ geom_boxplot()

# Not uninterpretable data
# ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = BMI))+ geom_boxplot()

# Using weight instead, roughly the same
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Weight_min))+ geom_boxplot()

# Patients who died had older age
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Age))+ geom_boxplot()

# No difference
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = Length_of_stay))+ geom_boxplot()

# Patients who died had higher SAPS1 and SOFA scores
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = SAPS1))+ geom_boxplot()
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = SOFA))+ geom_boxplot()

# cardiac surgery recovery unit have a smaller death circle compared to the other 3 ICU units
# ie less proportion of in hospital deaths compared to alive
ggplot(data=icu_patients_df1, mapping = aes(x = in_hospital_death=="1", y = ICUType)) + 
  geom_count(aes(size = after_stat(prop), group = ICUType)) + 
  scale_size_area(max_size = 50)

```

3. Fit appropriate univariate logistic regression models.

``` {r task1.3}
# univariate comparisons above
# removed: Mg_min, Na_min, Na_max, MAP_diff, MAP_max

### significant variables ###
minAlbumin_glm <- glm(in_hospital_death ~ Albumin_min, data=icu_patients_df1, family="binomial")
summary(minAlbumin_glm)

maxBili_glm <- glm(in_hospital_death ~ Bilirubin_max, data=icu_patients_df1, family="binomial")
summary(maxBili_glm)

maxUrea_glm <- glm(in_hospital_death ~ BUN_max, data=icu_patients_df1, family="binomial")
summary(maxUrea_glm)

maxCr_glm <- glm(in_hospital_death ~ Creatinine_max, data=icu_patients_df1, family="binomial")
summary(maxCr_glm)

minGCS_glm <- glm(in_hospital_death ~ GCS_min, data=icu_patients_df1, family="binomial")
summary(minGCS_glm)

maxGlu_glm <- glm(in_hospital_death ~ Glucose_max, data=icu_patients_df1, family="binomial")
summary(maxGlu_glm)

maxHR_glm <- glm(in_hospital_death ~ HR_max, data=icu_patients_df1, family="binomial")
summary(maxHR_glm)

maxLactate_glm <- glm(in_hospital_death ~ Lactate_max, data=icu_patients_df1, family="binomial")
summary(maxLactate_glm)

minPaCO2_glm <- glm(in_hospital_death ~ PaCO2_min, data=icu_patients_df1, family="binomial")
summary(minPaCO2_glm)

minpH_glm <- glm(in_hospital_death ~ pH_min, data=icu_patients_df1, family="binomial")
summary(minpH_glm)

maxRR_glm <- glm(in_hospital_death ~ RespRate_max, data=icu_patients_df1, family="binomial")
summary(maxRR_glm)

minTemp_glm <- glm(in_hospital_death ~ Temp_min, data=icu_patients_df1, family="binomial")
summary(minTemp_glm)

maxTropT_glm <- glm(in_hospital_death ~ TroponinT_max, data=icu_patients_df1, family="binomial")
summary(maxTropT_glm)

minUrine_glm <- glm(in_hospital_death ~ Urine_min, data=icu_patients_df1, family="binomial")
summary(minUrine_glm)

maxWBC_glm <- glm(in_hospital_death ~ WBC_max, data=icu_patients_df1, family="binomial")
summary(maxWBC_glm)

age_glm <- glm(in_hospital_death ~ Age, data=icu_patients_df1, family="binomial")
summary(age_glm)

gender_glm <- glm(in_hospital_death ~ Gender, data=icu_patients_df1, family="binomial")
summary(gender_glm)

icuType_glm <- glm(in_hospital_death ~ ICUType, data=icu_patients_df1, family="binomial")
summary(icuType_glm)

SAPS_glm <- glm(in_hospital_death ~ SAPS1, data=icu_patients_df1, family="binomial")
summary(SAPS_glm)

SOFA_glm <- glm(in_hospital_death ~ SOFA, data=icu_patients_df1, family="binomial")
summary(SOFA_glm)


### not significant variables but clinically relevant ###
maxFiO2_glm <- glm(in_hospital_death ~ FiO2_max, data=icu_patients_df1, family="binomial")
summary(maxFiO2_glm)

minHCT_glm <- minGlu_glm <- glm(in_hospital_death ~ HCT_min, data=icu_patients_df1, family="binomial")
summary(minHCT_glm)

maxK_glm <- glm(in_hospital_death ~ K_max, data=icu_patients_df1, family="binomial")
summary(maxK_glm) # not sigifnicant but has been included in the SAPS

minMAP_glm <- glm(in_hospital_death ~ MAP_min, data=icu_patients_df1, family="binomial")
summary(minMAP_glm)

maxPaCO2_glm <- glm(in_hospital_death ~ PaCO2_max, data=icu_patients_df1, family="binomial")
summary(maxPaCO2_glm)

minPaO2_glm <- glm(in_hospital_death ~ PaO2_min, data=icu_patients_df1, family="binomial")
summary(minPaO2_glm)

minPlt_glm <- glm(in_hospital_death ~ Platelets_min, data=icu_patients_df1, family="binomial")
summary(minPlt_glm) # not significant but has been included in the SOFA score

minSaO2_glm <- glm(in_hospital_death ~ SaO2_min, data=icu_patients_df1, family="binomial")
summary(minSaO2_glm)

minWeight_glm <- glm(in_hospital_death ~ Weight_min, data=icu_patients_df1, family="binomial")
summary(minWeight_glm)

LOS_glm <- glm(in_hospital_death ~ Length_of_stay, data=icu_patients_df1, family="binomial")
summary(LOS_glm)


### not significant and may not be clinically relevant ###
minGlu_glm <- glm(in_hospital_death ~ Glucose_min, data=icu_patients_df1, family="binomial")
summary(minGlu_glm)

minHR_glm <- glm(in_hospital_death ~ HR_min, data=icu_patients_df1, family="binomial")
summary(minHR_glm)

minK_glm <- glm(in_hospital_death ~ K_min, data=icu_patients_df1, family="binomial")
summary(minK_glm)

maxpH_glm <- glm(in_hospital_death ~ pH_max, data=icu_patients_df1, family="binomial")
summary(maxpH_glm)

maxTemp_glm <- glm(in_hospital_death ~ Temp_max, data=icu_patients_df1, family="binomial")
summary(maxTemp_glm)


# IN SUMMARY:
# Variables that are significant on univariate and clinically relevant are:
# minAlbumin, maxBili, maxUrea, maxCr, minGCS, maxGlu, maxHR, maxLactate, minPaCO2
# minpH, maxRR, minTemp, maxTropT, minUrine, maxWBC
# age, gender, icuType, SAPS, SOFA

# Variables not significant but still clinically relevant are:
# maxFiO2, minHCT, maxK, minMAP, maxPaCO2, minPaO2, minPlt, minSaO2, minWeight, LOS

# Variables not significant and may not be relevant are:
# minGlu, minHR, minK, maxpH, maxTemp
```

4. Fit an appropriate series of multivariable logistic regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

``` {r task1.4}

# Considering ALL variables:
# column 1 is record id
# column 2 is Length_of_stay
# column 3 is SAPS1
# column 4 is SOFA
# column 5 is survival
# column 7 is days
# column 8 is status
# column 9 is age
# column 43 is gender
# column 53 is Height
# column 57 is ICUType
# these columns should be excluded - the relevant ones will be reincluded in future models


# Split looking at all the variables by min,max,diff
# If trying to look at all variables at the same time, leads to linearity error

### min ICU data ###

minICUdata <- icu_patients_df1[, -c(1,2,3,4,5,7,8,9,43,53,57)] # remove columns as above
minICUdata <- minICUdata[, c(1, seq(from=4, to=109, by = 3))] # every third column starting from a min column

minICU_glm <- glm(in_hospital_death ~ . ,data=minICUdata, family="binomial")
summary(minICU_glm)
# Bilirubin_min, BUN_min, HCT_min, Lactate_min, Temp_min, Na_min, PaO2_min, Urine_min were statistically significant


###  max ICU data ### 
maxICUdata <- icu_patients_df1[, -c(1,2,3,4,5,7,8,9,43,53,57)] # remove columns as above
maxICUdata <- maxICUdata[, c(1, seq(from=3, to=109, by = 3))] # every third column starting from a max column

maxICU_glm <- glm(in_hospital_death ~ . ,data=maxICUdata, family="binomial")
summary(maxICU_glm)
# BUN_max, Creatinine_max, GCS_max, Platelet_max, Temp_max, Urine_max were statistically significant

### diff ICU data ### 
diffICUdata <- icu_patients_df1[, -c(1,2,3,4,5,7,8,9,43,53,57)] # remove columns as above
diffICUdata <- diffICUdata[, c(1, seq(from=2, to=109, by = 3))] # every third column starting from a diff column

diffICU_glm <- glm(in_hospital_death ~ . ,data=diffICUdata, family="binomial")
summary(diffICU_glm)
# Albumin_diff, Bilirubin_diff, BUN_diff, Mg_diff, NISysABP_diff, Urine_diff were statistically significant

sum(is.na(icu_patients_df1$NISysABP_diff)) # there are 453 missing values from NISysABP_diff column! removed



### if you built a model that used the min/max/diff significant variables:

minmaxdiffICU_glm <- glm(in_hospital_death ~ Age + Length_of_stay + SOFA + SAPS1 + ICUType + Gender +
                           #min variables that were significant
                           Bilirubin_min + BUN_min + HCT_min + Lactate_min + Temp_min + Na_min + PaO2_min + Urine_min + 
                           #max variables that were significant
                           BUN_max + Creatinine_max + GCS_max + Platelets_max + Temp_max + Urine_max +
                           #diff variables that were significant
                           Albumin_diff + Bilirubin_diff + BUN_diff + Mg_diff + Urine_diff # NISysABP_diff removed because of missing values
                           ,data=icu_patients_df1, family="binomial")

summary(minmaxdiffICU_glm)

step_minmaxdiffICU_glm <- step(minmaxdiffICU_glm, trace=1)
summary(step_minmaxdiffICU_glm)

# predictors left behind after step() are:
# Age, SAPS1, ICUType
# Albumin_diff
# Bilirubin_min, Bilirubin_diff
# BUN_min, BUN_diff
# Creatinine_max
# GCS_max
# Lactate_min
# Na_min
# Platelets_max
# Temp_min
# Urine_max, Urine_diff







```

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.
```{r task1.5}

finalICU_glm <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # predictors that are clinically relevant but not included in above
                      
                      # baseline demographics should be included even if not significant
                      Gender + Length_of_stay + Weight_min + 
                      SOFA + # an indicator of how well SOFA score determines mortality independent to its components
                      
                      # other clinical relevance
                      Albumin_min + # low albumin indicates malnutrition or liver failure
                      Glucose_max + # hyperglycaemia is a stress response
                      HCT_min + # low HCT = anaemia
                      HR_max + # tachycardia may indicate septic shock / inflammation
                      PaO2_min + # hypoxia = inadequate organ perfusion/oxygenation
                      PaCO2_min + #hypercapnia = respiratory / ventilation failure
                      pH_min + # indicates acidaemia / inadequate organ perfusion
                      RespRate_max + # indicates respiratory failure
                      TroponinT_max + # indicates myocardial damage
                      WBC_max # indicates infection
                      
                    ,data=icu_patients_df1, family="binomial")
summary(finalICU_glm)
```


Test some interaction terms based on clinical knowledge

```{r testing-interactions}
# based on clinical knowledge, test some interaction terms
# add one new term on top of finalICU_glm per model
# then compare models with interactions with baseline model

# finalICU_glm_2 = finalICU_glm + Age:Creatinine_max
finalICU_glm_2 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      + Age:Creatinine_max # creatinine generally increases with age
                     , data=icu_patients_df1, family="binomial")

# finalICU_glm_3 = finalICU_glm + Age:Temp_min
finalICU_glm_3 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      + Age:Temp_min # low temp more often associated with illness in the elderly e.g. cold sepsis
                     , data=icu_patients_df1, family="binomial")

# finalICU_glm_4 = finalICU_glm + Age:Weight_min
finalICU_glm_4 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      + Age:Weight_min # weight generally decreases with age
                     , data=icu_patients_df1, family="binomial")

# finalICU_glm_5 = finalICU_glm + Age:Albumin_min
finalICU_glm_5 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      Age:Albumin_min # albumin can decrease with age
                    , data=icu_patients_df1, family="binomial")

# finalICU_glm_6 = finalICU_glm + Gender:HCT_min
finalICU_glm_6 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      Gender:HCT_min # HCT can be lower in females than males
                    , data=icu_patients_df1, family="binomial")

# finalICU_glm_7 = finalICU_glm + PaO2_min:RespRate_max
finalICU_glm_7 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      PaO2_min:RespRate_max # PaO2 and resp rate are intrinsically related physiologically
                    , data=icu_patients_df1, family="binomial")

# finalICU_glm_8 = finalICU_glm + Age:ICUType
finalICU_glm_8 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction term
                      Age:ICUType # age is likely to be related to ICU type 
                                  # e.g. elderly more likely to have poor outcome after surgery requiring post-op ICU support
                    , data=icu_patients_df1, family="binomial")


# comparing models with anova
lapply(list(finalICU_glm_2, finalICU_glm_3, finalICU_glm_4, finalICU_glm_5,
            finalICU_glm_6, finalICU_glm_7, finalICU_glm_8), 
       function(x) {print(anova(finalICU_glm, x, test="Chisq"))} )
  # the effect of weight_min varied with age
  # the effect of ICUType varied with age
  # borderline -- the effect of resprate_max varied with PaO2_min

## feel free to add other interactions to test


# input the significant interaction terms into a model and examine output
finalICU_glm_9 <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                      
                      # baseline demographics 
                      Gender + Length_of_stay + Weight_min + SOFA + 
                      
                      # other clinical relevance
                      Albumin_min + Glucose_max + HCT_min + HR_max +  PaO2_min +
                      PaCO2_min + pH_min + RespRate_max + TroponinT_max + 
                      WBC_max +
                      
                      # interaction terms
                      Age:Weight_min + Age:ICUType # effects that had a significant effect on the model with anova
                    , data=icu_patients_df1, family="binomial")

summary(finalICU_glm_9)
# the AIC is slightly lower than finalICU_glm

## the effects of the interactions have significance but the ORs are close to 1 with narrow CIs -- perhaps not very clinically informative (i.e. the odds are essentially 1 i.e. equal)
options(scipen=999)
exp(coef(finalICU_glm_9))
exp(confint(finalICU_glm_9))
```

Testing the modified poisson regression, as the outcome is 14% in this data (>10% - common)

```{r task 1.5_test-poisson}

# test using modified poisson regression for more common outcomes on the same covariates as above

finalICU_glm_poisson <- glm(in_hospital_death ~ 
                      # significant predictors from step()
                      Age + SAPS1 + ICUType + Albumin_diff + Bilirubin_min + 
                      Bilirubin_diff + BUN_min + BUN_diff + Creatinine_max + 
                      GCS_max + Lactate_min + Na_min + Platelets_max + 
                      Temp_min + Urine_max + Urine_diff +
                        
                      # baseline demographics should be included even if not significant
                      Gender + Length_of_stay + Weight_min + 
                      SOFA + # an indicator of how well SOFA score determines mortality independent to its components
                      
                      # other clinical relevance
                      Albumin_min + # low albumin indicates malnutrition or liver failure
                      Glucose_max + # hyperglycaemia is a stress response
                      HCT_min + # low HCT = anaemia
                      HR_max + # tachycardia may indicate septic shock / inflammation
                      PaO2_min + # hypoxia = inadequate organ perfusion/oxygenation
                      PaCO2_min + #hypercapnia = respiratory / ventilation failure
                      pH_min + # indicates acidaemia / inadequate organ perfusion
                      RespRate_max + # indicates respiratory failure
                      TroponinT_max + # indicates myocardial damage
                      WBC_max # indicates infection
                      
                    , data=icu_patients_df1, family="poisson"(link="log"))

summary(finalICU_glm_poisson)

# fewer significant variables (likely as CI can be wider in poisson)
# but the variables that are significant were also significant in the logistic model

# examine ORs from logistic regression
options(scipen=999) # turn off scientific notation
exp(coef(finalICU_glm))

# examine RRs from logistic regression
exp(coef(finalICU_glm_poisson))

# the ORs and RRs appear very similar --> check the actual differences
exp(coef(finalICU_glm))-exp(coef(finalICU_glm_poisson))
# the intercept is very different (by 82000!) - not sure how to interpret that. the other estimates are very similar

# perhaps the logistic model is therefore justified? just need to be careful in interpretation using 'odds' rather than 'risk'
```


6. For your final model, present a set of diagnostic statistics and/or charts and comment on them.

```{r task1.6}
library(magrittr)
library(dplyr)

# lots of missing data in:
# Survival, ABP, NIBP variables
# some missing data in SAPS1 and Weight - correlates with GLM full model missing data
for(i in 1:length(colnames(icu_patients_df1))){
  print(c(i,colnames(icu_patients_df1[i]), sum(is.na(icu_patients_df1[i]))))
}

# remove observations with missing values from the data frame, 
# because they are automatically dropped by glm()

# remove the survival, ABP, some of the BP, height columns first
icu_patients_df1_nm <- icu_patients_df1[, -c(5,34:36,53,73:81, 100:102)]
icu_patients_df1_nm <- na.omit(icu_patients_df1_nm)


### Goodness of fit using bins ###

# add predicted probabilities to the data frame
icu_patients_df1_nm %>% mutate(predprob=predict(finalICU_glm, type="response"),
                   linpred=predict(finalICU_glm)) %>%
# group the data into bins based on the linear predictor fitted values
group_by(cut(linpred, breaks=unique(quantile(linpred, (1:50)/51)))) %>%
# summarise by bin
summarise(death_bin=sum(in_hospital_death), predprob_bin=mean(predprob), n_bin=n()) %>%
# add the standard error of the mean predicted probaility for each bin
mutate(se_predprob_bin=sqrt(predprob_bin*(1 - predprob_bin)/n_bin)) %>%
# plot it with 95% confidence interval bars
ggplot(aes(x=predprob_bin, 
           y=death_bin/n_bin, 
           ymin=death_bin/n_bin - 1.96*se_predprob_bin,
           ymax=death_bin/n_bin + 1.96*se_predprob_bin)) +
  geom_point() + geom_linerange(colour="orange", alpha=0.4) +
  geom_abline(intercept=0, slope=1) + 
  labs(x="Predicted probability (binned)",
       y="Observed proportion (in each bin)")
# the ideal calibration line fits within most of the dots and their 95% CI

### Goodness of fit using Hosmer Lemeshow stat ###

icu_patients_df1_nm %>% mutate(predprob=predict(finalICU_glm, type="response"),
                   linpred=predict(finalICU_glm)) %>%
group_by(cut(linpred, breaks=unique(quantile(linpred, (1:50)/51)))) %>%
summarise(death_bin=sum(in_hospital_death), predprob_bin=mean(predprob), n_bin=n()) %>%
mutate(se_predprob_bin=sqrt(predprob_bin*(1 - predprob_bin)/n_bin)) -> hl_df

hl_stat <- with(hl_df, sum( (death_bin - n_bin*predprob_bin)^2 /
                            (n_bin* predprob_bin*(1 - predprob_bin))))
hl <- c(hosmer_lemeshow_stat=hl_stat, hl_degrees_freedom=nrow(hl_df) - 1)
hl

# calculate p-value
c(p_val=1 - pchisq(hl[1], hl[2])) # the p value here is not statistically significant, indicating no lack of fit


### Brier score ###

get_brier <- function(model){
  predprob <- predict(model, type="response")
  Brier_score <- mean((predprob - icu_patients_df1_nm$in_hospital_death)^2)
  return(Brier_score)
}

get_brier(finalICU_glm)
get_brier(minmaxdiffICU_glm)
get_brier(step_minmaxdiffICU_glm)

# the final model has the lowest brier score -> lower score is better fit

```


7. Write a paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation.



#####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 





# Task 2 (15 marks)

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately explains or predicts the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a series of models, maybe three or four, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. Aim for between five and ten predictor variables (slightly more or fewer is OK). It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at least comment on the possible impact of what your diagnostics show). Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.


### Hints

1. Select an initial subset of explanatory variables that you will use to predict survival. Justify your choice.

```{r task 2.1}
library(survival)
# Initial variables used to predict survival
# (copied from Task 1)

## ICU first 24 hrs clinical data:
# Albumin_min : low albumin assoc with malnutrition 
# Bilirubin_max: may indicate liver failure and also is included in SOFA scoring
# BUN_max : high urea assoc with renal impairment
# Creatinine_max : high creatinine assoc with renal impairment
# FiO2_max : high oxygen requirements indicate lung pathology
# GCS_min : low GCS indicates head pathology
# Glucose_min : both hypo and hyperglycaemia can contribute to mortality
# Glucose_max
# HCT_min : HCT or haemoglobin assoc with mortality
# HR_min : too high or too low HR can cause cardiac issues
# HR_max
# K_min : both hypo and hyperkalaemia can indicate pathology
# K_max
# Lactate_max : high lactate is a marker of inadequate organ perfusion
# Mg_min : low magnesium could result in arrhythmias
# MAP_min : hypoperfusion leads to morbidity
# MAP_max : hyperperfusion / dysregulation of circulation could lead to morbidity
# MAP_diff
# MechVent : mech vent associated with mortality
# Na_min : both hypo and hypernatremia can lead to brain oedema / damage / seizures
# Na_max
# PaCO2_min 
# PaCO2_max : hypercapnia can result from ventilatory failure
# PaO2_min : because oxygen is important
# pH_min : both acidaemia and alkaemia indicates systemic or renal pathology
# pH_max
# Platelets_min : low platelets indicate higher risk of bleeding
# RespRate_max : high RR is related to mortality
# SaO2_min : because oxygen is important
# Temp_min : hypothermia / hyperthermia may lead to morbiditiy
# Temp_max
# TropT_max : indicates myocardial injury
# Urine_min : low urine output indicates renal impairment
# WBC_max : presence of infection
# Weight : whether obesity has any contributing factors

# Non clinical variables:
# age
# gender
# height (and therefore BMI)
# ICUType
# Length_of_stay
# SAPS1
# ICUType

# Variables I am unsure of clinical significant:
# ALP / ALT / AST
# HCO3


## Some univariate models
# at the moment, this is predicting mortality (status=0 if survives by end of follow-up; status=1 if dies)
# do we need to switch the status variable to predict survival? or we can just interpret accordingly as mortality != survival?

# started working through some variables I thought might be significant
age_cox <- coxph(Surv(Days, Status) ~ Age, data=icu_patients_df1)
summary(age_cox)

gender_cox <- coxph(Surv(Days, Status) ~ Gender, data=icu_patients_df1)
summary(gender_cox)

icutype_cox <- coxph(Surv(Days, Status) ~ ICUType, data=icu_patients_df1)
summary(icutype_cox)

los_cox <- coxph(Surv(Days, Status) ~ Length_of_stay, data=icu_patients_df1)
summary(los_cox)

saps1_cox <- coxph(Surv(Days, Status) ~ SAPS1, data=icu_patients_df1)
summary(saps1_cox)

sofa_cox <- coxph(Surv(Days, Status) ~ SOFA, data=icu_patients_df1)
summary(sofa_cox)

weight_cox <- coxph(Surv(Days, Status) ~ Weight_min, data=icu_patients_df1)
summary(weight_cox)

minalb_cox <- coxph(Surv(Days, Status) ~ Albumin_min, data=icu_patients_df1)
summary(minalb_cox)

maxbili_cox <- coxph(Surv(Days, Status) ~ Bilirubin_min, data=icu_patients_df1)
summary(maxbili_cox)


```

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate Cox proportional hazards models.

4. Fit an appropriate series of multivariable Cox proportional hazards models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them. 

7. Write a very brief paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation. 

####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 



## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works, and then submit via the drop box in OpenLearning.

## Submit your assignment

When you have finished, and are satisfied with your assignment solutions, and this file knits without errors and the output looks the way you want, then you should submit via the drop box in OpenLearning.

### Problems?

If you encounter problems with any part of the process described above, please contact the course convenor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assignment is due.


### Additional Information

Each task attracts the indicated number of marks (out of a total of 30 marks for the assignment). The instructions are deliberately open-ended and less prescriptive than the individual assignments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks and gain full marks, you only need to replicate or repeat the steps covered in the course - if you do most or all of the things described in the revalant chapters of the HDAT9600 course, full marks will be awarded. 

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course convenor.
