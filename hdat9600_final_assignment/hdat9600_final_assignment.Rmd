---
title: "HDAT9600 Final Assignment"
subtitle: "Submission deadline: Monday 10 May 2021, 9am AEST"
author: "Meg Stevens, Maathumai Ranjan, Victor Hui, Haran Nathan"
date: "Last modified: 9 May 2021"
output: html_document
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)
```

## Instructions

This file (hdat9600_final_assignment.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final assignment. This assignment is assessed and will count for 30% of the total course marks. The assignment comprises two tasks worth 15 marks each. The first task will focus on logistic regression, and the second task will focus on survival analysis. There is no word limit, but a report of about 10 pages in length when printed (except that it will not be printed) is appropriate.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor are happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assignments for you!


## Data for this assignment

The data used for this assignment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assignment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. The original data has been modified and assembled to suit the purpose of this assignment. While not required for the purposes of this assignment, full details of the preparatory work can be found in the hdat9600_final_assignment_data_preparation file.

The dataframe consists of 120 variables, which are defined as follows:

#### Patient Descriptor Variables
<li> <em>RecordID:</em>            a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patientâ€™s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


#### Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


#### Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

<li> <em>SAPS-I score</em> [Simplified Acute Physiological Score (<a href="http://www.ncbi.nlm.nih.gov/pubmed/6499483"
target="_blank"><em>Le Gall et al., 1984</em></a>)]</li>
<li> <em>SOFA score</em> [Sequential Organ Failure Assessment (<a href="http://www.ncbi.nlm.nih.gov/pubmed/11594901"
target="_blank"><em>Ferreira et al., 2001</em></a>)]</li>

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

<li><a href="http://en.wikipedia.org/wiki/Human_serum_albumin" target="_blank">
<em>Albumin</em></a> (g/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Alkaline_phosphatase" target="_blank">
<em>ALP</em></a> [Alkaline phosphatase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Alanine_transaminase" target="_blank">
<em>ALT</em></a> [Alanine transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Aspartate_transaminase" target="_blank">
<em>AST</em></a> [Aspartate transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bilirubin" target="_blank">
<em>Bilirubin</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/BUN" target="_blank">
<em>BUN</em></a> [Blood urea nitrogen (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Cholesterol" target="_blank">
<em>Cholesterol</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine"
target="_blank">
<em>Creatinine</em></a> [Serum creatinine (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>DiasABP</em></a> [Invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/FIO2" target="_blank">
<em>FiO2</em></a> [Fractional inspired O<sub>2</sub> (0-1)]</li>
<li><a href="http://en.wikipedia.org/wiki/Glasgow_coma_score" target="_blank">
<em>GCS</em></a> [Glasgow Coma Score (3-15)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_glucose" target="_blank">
<em>Glucose</em></a> [Serum glucose (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics"
target="_blank">
<em>HCO3</em></a> [Serum bicarbonate (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hematocrit" target="_blank">
<em>HCT</em></a> [Hematocrit (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Heart_rate" target="_blank">
<em>HR</em></a> [Heart rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hypokalemia" target="_blank">
<em>K</em></a> [Serum potassium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Lactic_acid" target="_blank">
<em>Lactate</em></a> (mmol/L)</li>
<li><a href="http://en.wikipedia.org/wiki/Magnesium#Biological_role"
target="_blank">
<em>Mg</em></a> [Serum magnesium (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>MAP</em></a> [Invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mechanical_ventilation"
target="_blank">
<em>MechVent</em></a> [Mechanical ventilation respiration (0:false, or 1:true)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_sodium" target="_blank">
<em>Na</em></a> [Serum sodium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>NIDiasABP</em></a> [Non-invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>NIMAP</em></a> [Non-invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>NISysABP</em></a> [Non-invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaCO2</em></a> [partial pressure of arterial CO<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaO2</em></a> [Partial pressure of arterial O<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>pH</em></a> [Arterial pH (0-14)]</li>
<li><a href="http://en.wikipedia.org/wiki/Platelets" target="_blank">
<em>Platelets</em></a> (cells/nL)</li>
<li><a href="http://en.wikipedia.org/wiki/Respiratory_physiology" target="_blank">
<em>RespRate</em></a> [Respiration rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>SaO2</em></a> [O<sub>2</sub> saturation in hemoglobin (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>SysABP</em></a> [Invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Normal_human_body_temperature"
target="_blank">
<em>Temp</em></a> [Temperature (&deg;C)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropI</em></a> [Troponin-I (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropT</em></a> [Troponin-T (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Fluid_balance" target="_blank">
<em>Urine</em></a> [Urine output (mL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology" target="_blank">
<em>WBC</em></a> [White blood cell count (cells/nL)]</li>
<li>
<em>Weight</em> (kg)</li>


## Accessing the Data
The data frame can be loaded with the following code:

``` {r task-setup}
# import required packages
library(ggplot2)
library(gridExtra)
library(magrittr)
library(dplyr)
library(DescTools)
library(survival)
library(eha)
library(stringi)
library(bshazard)
library(survminer)

# Getting the path of your current open file
# Extra code to ensure this file imports data in local directory
library(rstudioapi)
current_path <- rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path ))

# import data
icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")

```
**Note:** icu_patients_df1 is an imputed (i.e. missing values are 'derived') version of icu_patients_df0.  This assignment does not concern the methods used for imputation.


# Task 1 (15 marks)

In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately explains or predicts the `in_hospital_death` variable as the outcome using a subset of the available predictor variables. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct or complete, but do you best). Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of diagnostic statistics and/or charts and comment on them. You don't need to do an exhaustive exploratory data analysis of all the variables in the data set, but you should examine those variables that you use in your model. Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


### Hints

1. Select an initial subset of explanatory variables that you will use to predict the risk of in-hospital death. Justify your choice.

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate logistic regression models.

4. Fit an appropriate series of multivariable logistic regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them.

7. Write a paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation.


## Task 1 Response:

### Select an initial subset of explanatory variables:

The purpose of this task is to understand the impact of information collected during the first 24 hours of an ICU stay on in-hospital mortality of the ICU population.

To select a subset of explanatory variables, we have examined the SAPS1 score and the SOFA scores included in the dataset in more detail to ascertain which variables could be logically associated with increased mortality and poor survival. We have also assessed the clinical measures used to calculate the <a href="https://reference.medscape.com/calculator/12/apache-ii" target="_blank"> <em>APACHE score</em></a>  which is another commonly used measure in ICU risk prediction models.

`SAPS1` - Simplified Acute Physiology Score is a measure of the severity of disease for patients admitted to ICU. The following measures increases the SAPS1 score:

  * Advanced Age
  * Low and high Heart Rate
  * Low and high Systolic Blood Pressure
  * High Temperature
  * Low Glasgow Coma Scale (However it is most meaningful to use the highest GCS score available for prognostication)
  * Mechanical Ventilation or CPAP
  * High PaO2/ FiO2 ratio (It is likely that highest FiO2 is administered during lowest PaO2)
  * Low Urine Output
  * High Blood Urea Nitrogen
  * Low or High Sodium
  * Low or high Potassium
  * Low Bicarbonate
  * High Bilirubin
  * Low or High White Blood Cell
  * Chronic diseases
  * Type of admission (ie ICU Type)
  

`SOFA` - sequential organ failure assessment is a predictor of ICU mortality. The following measures increase the SOFA score:

  * Elevated PaO2/ FiO2 ratio- 
  * Reduced GCS - Nervous system
  * Reduced MAP - Cardiovascular system
  * Administration of vasopressors - Cardiovascular system
  * High Bilirubin - Liver
  * Low Platelets - Coagulation
  * High Creatinine - Kidneys
  * Low Urine - Kidneys
  
  
The `APACHE` score is commonly used validated risk score for ICU risk prediction. The variables that increase the APACHE score include:

  * Advanced Age
  * High or Low Temperature
  * High or Low MAP
  * High or Low HR
  * High or Low Respiratory Rate
  * High PaO2/FiO2 ratio
  * High or Low pH
  * High or Low Na
  * High or Low K
  * High Creatinine
  * High or low HCT
  * High or Low WBC


In the exploratory analysis, we include variables that will increase SOFA, SAPS or APACHE scores (note that higher SOFA, SAPS and APACHE scores are associated with higher risk of mortality). For example, increased BUN and reduced HCO3 will increase the SAPS score, therefore we will include `BUN_max` (but not `BUN_min` and `BUN_diff`) and `HCO3_min` (but not `HCO3_max` and `HCO3_diff`). Where both extremes of a variable will increase the risk score, both `min` and `max` variables will be included.
        
Other factors known to be associated with morbidity/ mortality not included in risk scores: 
  * Height/ weight - Body composition/ BMI is associated with mortality and survival
  * Gender - Males are typically associated with high risk of mortality
  * Glucose - high and low Glucose levels are associated with pathology
  * Troponin T and I - high troponin results (cardiac biomarkers) associated with morbidity and mortality
  * Lactate - elevated lactate is associated with poor organ perfusion and ICU morbidity/ mortality
  * Albumin - reduced albumin is associated with poor clinical outcomes
  
  
Therefore, the initial subset of explanatory variables we have chosen for this task are:

DEMOGRAPHIC VARIABLES: <br>
  * `Age`<br>
  * `Gender`<br>
  * `ICUType`<br>
  * `Height`<br>
  * `Length_of_stay`<br>
  * `Weight_max`<br><br>
  
CLINICAL VARIABLES: <br>
  * `Albumin_min`<br>
  * `Bilirubin_max`<br>
  * `BUN_max`<br>
  * `Creatinine_max`<br>  
  * `GCS_min`<br>
  * `Glucose_min` and `Glucose_max`<br>
  * `HCO3_min`<br>
  * `HR_min` and `HR_max`<br>
  * `K_min` and `K_max`<br>
  * `Lactate_max`<br>
  * `MAP_min`<br>
  * `Na_min` and `Na_max`<br> 
  * `NISysABP_min` and `NISysABP_max`<br> 
  * `Platelets_min`<br>
  * `FiO2_max` and `PaO2_min` - included as `PFratio`= `PaO2_min`/ `FiO2_max`<br>
  * `pH_min` and `pH_max`<br>
  * `RespRate_min` and `RespRate_max`<br>
  * `Temp_min` and `Temp_max`<br>
  * `TroponinI_max`<br>
  * `TroponinT_max`<br>
  * `Urine_min`<br>
  * `WBC_min` and `WBC_max`<br>


### Basic initial exploratory data analysis (EDA):

``` {r task1.2.1, fig.width=20, fig.height=90}
# create new variable PF ratio as part of our list of variables to include
icu_patients_df1$PFratio<-icu_patients_df1$PaO2_min/icu_patients_df1$FiO2_max
icu_patients_df0$PFratio<-icu_patients_df0$PaO2_min/icu_patients_df0$FiO2_max

# create a vector of the variables chosen to explore
explore_vars <- c('Age', 'Gender', 'ICUType', 'Height', 'Weight_max', 
                  'Albumin_min', 'Bilirubin_max', 'BUN_max', 'Creatinine_max', 
                  'GCS_min', 'Glucose_min', 'Glucose_max', 'HCO3_min', 'HR_min', 
                  'HR_max', 'K_min', 'K_max', 'Lactate_max', 'Length_of_stay', 
                  'MAP_min', 'Na_min', 'Na_max', 'NISysABP_min', 'NISysABP_max', 
                  'Platelets_min', 'PFratio', 'pH_min', 'pH_max', 
                  'RespRate_min', 'RespRate_max', 'Temp_min', 'Temp_max', 
                  'TroponinI_max', 'TroponinT_max', 'Urine_min', 'WBC_min', 
                  'WBC_max')

# examine the summary output for each chosen variable
summary(icu_patients_df1[,explore_vars])


# Write a function to plot box plots for each variable by in_hospital_death
boxplot_eda <- function(variable){
  plot <- ggplot(data=icu_patients_df1, 
          mapping = aes(x = in_hospital_death=="1", 
                        y = icu_patients_df1[,variable])) + 
          geom_boxplot() +
          labs(title=paste('Box plot of',variable), 
               x='In hospital death', y=variable)
  return(plot)
}


# Continuous variables EDA and their interpretation

# continuous variables from the list of initial subset of explanatory variables
cont_vars <- c('Age', 'Height', 'Weight_max', 'Albumin_min', 'Bilirubin_max',
               'BUN_max', 'Creatinine_max', 'GCS_min', 'Glucose_min',
               'Glucose_max', 'HCO3_min', 'HR_min', 'HR_max', 'K_min', 'K_max',
               'Lactate_max', 'Length_of_stay', 'MAP_min', 'Na_min', 'Na_max', 'NISysABP_min',
               'NISysABP_max', 'Platelets_min', 'PFratio', 'pH_min', 'pH_max',
               'RespRate_min', 'RespRate_max', 'Temp_min', 'Temp_max',
               'TroponinI_max', 'TroponinT_max', 'Urine_min', 'WBC_min', 'WBC_max')

# Loop through the continuous variables and produce box plots using the boxplot_eda() function 
b <- list() # initialise an empty list to store the plots in
for(i in 1:length(cont_vars)){
  b[[i]] <- boxplot_eda(cont_vars[i])
}
# arrange the list of plots in a 12 row grid using grid.arrange() from package{gridExtra}
do.call(grid.arrange, c(b, nrow = 12))

```

```{r task 1.2.2} 

# Examine SAPS1 and SOFA scores by in_hospital_death
# Given our variables were chosen based on these scores
ggplot(data=icu_patients_df1, 
       mapping = aes(x = in_hospital_death=="1", y = SAPS1)) + geom_boxplot() +
       labs(title=paste('Box plot of SAPS1 scores'), 
            x='In hospital death', y='SAPS1 score')

ggplot(data=icu_patients_df1, 
       mapping = aes(x = in_hospital_death=="1", y = SOFA)) + geom_boxplot() +
       labs(title=paste('Box plot of SOFA scores'), 
            x='In hospital death', y='SOFA score')


### Categorical variables EDA ###

# plot ICU type by in_hospital_death and change the size of the circle to represent proportion
icutype_plot <- ggplot(data=icu_patients_df1, 
                       mapping = aes(x = in_hospital_death=="1", y = ICUType)) + 
                geom_count(aes(size = after_stat(prop), group = ICUType)) + 
                scale_size_area(max_size = 10) + 
                labs(title=paste('Proportion of patients by ICU type'), 
                     x='In hospital death', size='Proportion of patients')

# plot gender by in_hospital_death and change the size of the circle to represent proportion
gender_plot <- ggplot(data=icu_patients_df1, 
                      mapping = aes(x = in_hospital_death=="1", y = Gender)) + 
               geom_count(aes(size = after_stat(prop), group = ICUType)) + 
               scale_size_area(max_size = 20) + 
                labs(title=paste('Proportion of patients by gender'), 
                     x='In hospital death', size='Proportion of patients')

# arrange the categorical variable plots side-by-side
grid.arrange(icutype_plot, gender_plot, nrow=1)

```

**EDA Findings:**

* There are 2061 unique individuals in the dataset. Of these, 913 are female (44%) and 1148 are male (56%).
* There were 297 deaths out of 2061 observations, which is a risk rate of 14.4% (not an uncommon event).
* Medical ICU accounted for 38% of individuals, 26% in Surgical ICU, 24% in Cardiac Surgery recovery Unit and 14% in the Coronary Care unit.

* The following variables have a large proportion of missing observations:
    * `Weight_max` - 146 missing observations <br>
    * `Height` - 992 missing observations <br>
    * `NISysABP_min` & `NISysABP_max` - 453 missing observations <br>
* `Length_of_stay` has some invalid (-1) values
    
* Proportion of in hospital deaths were observed for each variable:
    * Those that died in hospital had higher SAPS1 and SOFA scores (as expected, as these scores are validated to predict mortality).
    * Females had higher proportion of in-hospital deaths than males.
    * Medical ICU had a greatest rate of in-hospital mortality, whereas Cardiac Surgery recovery unit had the lowest proportion of in-hospital deaths.
    * Those that died in hospital after ICU admission appear to have had:
        * Higher: age, respiratory rate, white blood cell count (WBC), maximum bilirubin/urea (BUN)/creatinine/glucose/heart rate/lactate
        * Lower: minimum albumin/GCS/bicarbonate (HCO3)/non-invasive systolic BP
    * From inspection of the box-plots, between the groups of patients who died in-hospital and those who survived, there were similar values for PFratio, minimum glucose/heart rate/potassium/mean arterial pressure/sodium/platelets/pH/temperature/urine output, and maximum potassium/sodium/non-invasive systolic BP/pH/temperature/troponin I and T.


### Univariate logistic regression models:

``` {r task1.3}
# Fit univariate logistic regression for all initial selected variables
# Examine the ORs by exponentiating the coefficients of the models

# Age
age_glm <- glm(in_hospital_death ~ Age, data=icu_patients_df1, family="binomial")
summary(age_glm)
exp(coef(age_glm))

# Gender
gender_glm <- glm(in_hospital_death ~ Gender, data=icu_patients_df1, family="binomial")
summary(gender_glm)
exp(coef(gender_glm))

# ICU type
icuType_glm <- glm(in_hospital_death ~ ICUType, data=icu_patients_df1, family="binomial")
summary(icuType_glm)
exp(coef(icuType_glm))

# Length of stay
los_glm <- glm(in_hospital_death ~ Length_of_stay, data=icu_patients_df1, family="binomial")
summary(los_glm)
exp(coef(los_glm))

# Weight_max
maxWeight_glm <- glm(in_hospital_death ~ Weight_max, data=icu_patients_df1, family="binomial")
summary(maxWeight_glm)
exp(coef(maxWeight_glm))

# Albumin_min
minAlbumin_glm <- glm(in_hospital_death ~ Albumin_min, data=icu_patients_df1, family="binomial")
summary(minAlbumin_glm)
exp(coef(minAlbumin_glm))

# Bilirubin_max
maxBili_glm <- glm(in_hospital_death ~ Bilirubin_max, data=icu_patients_df1, family="binomial")
summary(maxBili_glm) 
exp(coef(maxBili_glm))

# BUN_max
maxUrea_glm <- glm(in_hospital_death ~ BUN_max, data=icu_patients_df1, family="binomial")
summary(maxUrea_glm) 
exp(coef(maxUrea_glm))

# Creatinine_max
maxCr_glm <- glm(in_hospital_death ~ Creatinine_max, data=icu_patients_df1, family="binomial")
summary(maxCr_glm)
exp(coef(maxCr_glm))

# GCS_min
minGCS_glm <- glm(in_hospital_death ~ GCS_min, data=icu_patients_df1, family="binomial")
summary(minGCS_glm)
exp(coef(minGCS_glm))

# Glucose_min
minGlu_glm <- glm(in_hospital_death ~ Glucose_min, data=icu_patients_df1, family="binomial")
summary(minGlu_glm) 
exp(coef(minGlu_glm))

# Glucose_max
maxGlu_glm <- glm(in_hospital_death ~ Glucose_max, data=icu_patients_df1, family="binomial")
summary(maxGlu_glm)
exp(coef(maxGlu_glm))

# HCO3_min
minHCO3_glm <- glm(in_hospital_death ~ HCO3_min, data=icu_patients_df1, family="binomial")
summary(minHCO3_glm)
exp(coef(minHCO3_glm))

# HR_min
minHR_glm <- glm(in_hospital_death ~ HR_min, data=icu_patients_df1, family="binomial")
summary(minHR_glm) 
exp(coef(minHR_glm))

# HR_max
maxHR_glm <- glm(in_hospital_death ~ HR_max, data=icu_patients_df1, family="binomial")
summary(maxHR_glm)
exp(coef(maxHR_glm))

# K_min
minK_glm <- glm(in_hospital_death ~ K_min, data=icu_patients_df1, family="binomial")
summary(minK_glm)
exp(coef(minK_glm))

# K_max
maxK_glm <- glm(in_hospital_death ~ K_max, data=icu_patients_df1, family="binomial")
summary(maxK_glm) 
exp(coef(maxK_glm))

# Lactate_max
maxLactate_glm <- glm(in_hospital_death ~ Lactate_max, data=icu_patients_df1, family="binomial")
summary(maxLactate_glm)
exp(coef(maxLactate_glm))

# MAP_min
minMAP_glm <- glm(in_hospital_death ~ MAP_min, data=icu_patients_df1, family="binomial")
summary(minMAP_glm)
exp(coef(minMAP_glm))

# Na_min
minNa_glm <- glm(in_hospital_death ~ Na_min, data=icu_patients_df1, family="binomial")
summary(minNa_glm) 
exp(coef(minNa_glm))

# Na_max
maxNa_glm <- glm(in_hospital_death ~ Na_max, data=icu_patients_df1, family="binomial")
summary(maxNa_glm)
exp(coef(maxNa_glm))

# NISysABP_min
minNISys_ABP_glm <- glm(in_hospital_death ~ NISysABP_min, data=icu_patients_df1, family="binomial")
summary(minNISys_ABP_glm)
exp(coef(minNISys_ABP_glm))

# NISysABP_max
maxNISys_ABP_glm <- glm(in_hospital_death ~ NISysABP_max, data=icu_patients_df1, family="binomial")
summary(maxNISys_ABP_glm)
exp(coef(maxNISys_ABP_glm))

# Platelets_min
minPlt_glm <- glm(in_hospital_death ~ Platelets_min, data=icu_patients_df1, family="binomial")
summary(minPlt_glm)
exp(coef(minPlt_glm))

# PFratio
maxPFratio_glm <- glm(in_hospital_death ~ PFratio, data=icu_patients_df1, family="binomial")
summary(maxPFratio_glm)
exp(coef(maxPFratio_glm))

# pH_min
minpH_glm <- glm(in_hospital_death ~ pH_min, data=icu_patients_df1, family="binomial")
summary(minpH_glm) 
exp(coef(minpH_glm))

# pH_max
maxpH_glm <- glm(in_hospital_death ~ pH_max, data=icu_patients_df1, family="binomial")
summary(maxpH_glm)
exp(coef(maxpH_glm))

# RespRate_min
minRR_glm <- glm(in_hospital_death ~ RespRate_min, data=icu_patients_df1, family="binomial")
summary(minRR_glm)
exp(coef(minRR_glm))

# RespRate_max
maxRR_glm <- glm(in_hospital_death ~ RespRate_max, data=icu_patients_df1, family="binomial")
summary(maxRR_glm)
exp(coef(maxRR_glm))

# Temp_min
minTemp_glm <- glm(in_hospital_death ~ Temp_min, data=icu_patients_df1, family="binomial")
summary(minTemp_glm)
exp(coef(minTemp_glm))

# Temp_max
maxTemp_glm <- glm(in_hospital_death ~ Temp_max, data=icu_patients_df1, family="binomial")
summary(maxTemp_glm) 
exp(coef(maxTemp_glm))

# TroponinI_max
maxTropI_glm <- glm(in_hospital_death ~ TroponinI_max, data=icu_patients_df1, family="binomial")
summary(maxTropI_glm) 
exp(coef(maxTropI_glm))

# TroponinT_max
maxTropT_glm <- glm(in_hospital_death ~ TroponinT_max, data=icu_patients_df1, family="binomial")
summary(maxTropT_glm)
exp(coef(maxTropT_glm))

# Urine_min
minUrine_glm <- glm(in_hospital_death ~ Urine_min, data=icu_patients_df1, family="binomial")
summary(minUrine_glm)
exp(coef(minUrine_glm))

# WBC_min
minWBC_glm <- glm(in_hospital_death ~ WBC_min, data=icu_patients_df1, family="binomial")
summary(minWBC_glm)
exp(coef(minWBC_glm))

# WBC_max
maxWBC_glm <- glm(in_hospital_death ~ WBC_max, data=icu_patients_df1, family="binomial")
summary(maxWBC_glm)
exp(coef(maxWBC_glm))

```
**Univariate Models Findings:**

On univariate analysis using logistic regression, the following variables of the initial selected subset had a significant effect on the `in_hospital_death` binary outcome (i.e. the null hypothesis of no effect was rejected with a Wald statistic p-value (Pr(>|z|)) < 0.05):

  * `Age` (OR: 1.03; p < 0.001) <br>
  * `ICUType` - Cardiac Surgery Recovery Unit (compared to Coronary Care Unit) OR: 0.32; p < 0.001 <br>
  * `Weight_max` (OR: 0.99; p = 0.03) <br>
  * `Albumin_min` (OR: 0.62; p < 0.001) <br>
  * `Bilirubin_max` (OR: 1.06; p < 0.001) <br>
  * `BUN_max` (OR: 1.02; p < 0.001) <br>
  * `Creatinine_max` (OR: 1.18; p < 0.001) <br>
  * `GCS_min` (OR: 0.96; p < 0.001) <br>
  * `Glucose_max` (OR: 1.00; p < 0.001) <br>
  * `HCO3_min` (OR: 0.93; p < 0.001) <br>
  * `HR_max` (OR: 1.01; p = 0.002) <br>
  * `Lactate_max` (OR: 1.15; p < 0.001) <br>
  * `Na_min` (OR: 0.97; p = 0.03) <br>
  * `NISysABP_min` (OR: 0.99; p < 0.001) <br>
  * `pH_min` (OR: 0.05; p < 0.001) <br>
  * `RespRate_min` (OR: 1.09; p < 0.001) <br>
  * `RespRate_max` (OR: 1.04; p < 0.001) <br>
  * `Temp_min` (OR: 0.77; p < 0.001) <br>
  * `TroponinT_max` (OR: 1.07; p = 0.01) <br>
  * `Urine_min` (OR: 0.99; p < 0.001) <br>
  * `WBC_min` (OR: 1.02; p = 0.04) <br>
  * `WBC_max` (OR: 1.01; p = 0.04) <br>
  
Interestingly, we see some values have an odds ratio that reduces risk of `in_hospital_death` i.e. OR < 1. At first glance, these seem counter-intuitive. For example, clinically, we expect those with low albumin (lower protein) to be associated with poorer outcomes than those with normal albumin levels; however, the OR for `Albumin_min` is 0.62. This does not mean that having low albumin reduces one's risk of `in_hospital_death`, rather, it should be interpreted as 'those with larger values of `Albumin_min` are less likely to die in hospital than those with lower values of `Albumin_min`'; i.e. those with a 'less low' or 'higher' `Albumin_min` value will fare better. Similar results can be seen on univariate analysis for `GCS_min`, `HCO3_min`, `Na_min`, `NISysABP_min`, `Temp_min` and `Urine_min`.


Variables without a significant effect on `in_hospital_death` are:

  * `Gender` <br>
  * `Length_of_stay` <br>
  * `Glucose_min` <br>
  * `HR_min` <br>
  * `K_min` <br>
  * `K_max` <br>
  * `MAP_min` <br>
  * `Na_max` <br>
  * `NISysABP_max` <br>
  * `Platelets_min` <br>
  * `PFratio` <br>
  * `pH_max` <br>
  * `Temp_max` <br>
  * `TroponinI_max` <br>


### Multivariable logistic regression models:

``` {r task1.4.1}

## Create a dataset without missing or invalid data to use to build the model ##
## in order to remain consistent and allow comparisons between models to be made ##


# Check counts of missing data in each variable
for(i in 1:length(colnames(icu_patients_df1))){
  print(c(i,colnames(icu_patients_df1[i]), sum(is.na(icu_patients_df1[i]))))
}
## Result: of the variables chosen to explore for the survival model, large amounts of missing data in:
##         Height (992), NISysABP_min (453), NISysABP_max (453), Weight_max (146)

## Decision: include Weight_max; remove Height, NISysABP_min, NISysABP_max


# Check counts of negative data (noted some -1 values) in each variable
for(i in 1:length(colnames(icu_patients_df1))){
  print(c(i,colnames(icu_patients_df1[i]), sum(icu_patients_df1[i] < 0)))
}
## Result: negative values in Length_of_stay and SOFA

# Create a new dataset with the only non-missing data from list of initial variables chosen
# (excluding those with very high missingness i.e. Height, NISysABP_min, NISysABP_max)
nm_icu_model_df1 <- na.omit(subset(icu_patients_df1, 
                                   select=c(Days, Status, # the survival object variables (for task 2)
                                            RecordID, # keep record id for reference if needed
                                            in_hospital_death, # for task 1
                                            Age, Gender, ICUType, Weight_max,
                                            Albumin_min, Bilirubin_max,
                                            BUN_max, Creatinine_max, 
                                            GCS_max, Glucose_min, Glucose_max, 
                                            HCO3_min, HR_min, HR_max, K_min, 
                                            K_max, Lactate_max, Length_of_stay, MAP_min, Na_min,
                                            Na_max, Platelets_min, PFratio, pH_min,
                                            pH_max, RespRate_min, RespRate_max,
                                            Temp_min, Temp_max, TroponinT_max, 
                                            TroponinI_max, Urine_min, WBC_min, WBC_max)))

# Also exclude the negative data in Length_of_stay
nm_icu_model_df1 <- nm_icu_model_df1[nm_icu_model_df1$Length_of_stay>=0,]
```

``` {r task1.4.2}

# Fit a multivariable glm to predict in_hospital_death using
# all variables from initially selected predictors
full_glm <- glm(in_hospital_death ~ 
                  Age + 
                  Gender + 
                  ICUType + 
                  Weight_max +
                  Albumin_min +
                  Bilirubin_max + 
                  BUN_max + 
                  Creatinine_max + 
                  GCS_max + 
                  Glucose_min + 
                  Glucose_max + 
                  HCO3_min +
                  HR_min + 
                  HR_max + 
                  K_min + 
                  K_max + 
                  Lactate_max + 
                  Length_of_stay +
                  MAP_min + 
                  Na_min +
                  Na_max +
                  Platelets_min +
                  PFratio +
                  pH_min +
                  pH_max +
                  RespRate_min +
                  RespRate_max + 
                  Temp_min + 
                  Temp_max +
                  TroponinT_max +
                  TroponinI_max + 
                  Urine_min + 
                  WBC_min + 
                  WBC_max
                , data=nm_icu_model_df1, family="binomial")
summary(full_glm) 

# Fit a multivariable model using predictor variables that were significant on univariate comparisons
# Note: NISysABP_min was not included as there was a large amount of missing data and was excluded from the dataset
signifUni_glm <- glm(in_hospital_death ~
                       Age + 
                       ICUType + 
                       Weight_max +
                       Albumin_min + 
                       Bilirubin_max + 
                       BUN_max + 
                       Creatinine_max +
                       GCS_max + 
                       Glucose_max + 
                       HCO3_min + 
                       HR_max +
                       Lactate_max +
                       Na_min +
                       pH_min + 
                       RespRate_min +
                       RespRate_max +
                       Temp_min + 
                       TroponinT_max +
                       Urine_min +
                       WBC_min +
                       WBC_max
                     ,data=nm_icu_model_df1, family="binomial")
summary(signifUni_glm) 


# Fit a multivariable model using predictor variables that were significant in the full_glm
signifFull_glm <- glm(in_hospital_death ~
                        Age + 
                        ICUType +
                        Albumin_min + 
                        Bilirubin_max + 
                        BUN_max + 
                        GCS_max + 
                        Temp_min + 
                        Urine_min + 
                        WBC_min + 
                        WBC_max
                      ,data=nm_icu_model_df1, family="binomial")
summary(signifFull_glm)

# Compare the reduced models with the full model using analysis of deviance
lapply(list(signifUni_glm, signifFull_glm), 
       function(x) {print(anova(full_glm, x, test="Chisq"))} )
  ## Result: signifUni_glm - support the null hypothesis that the reduced model is a better fit than the full model
  ##         signifFull_glm - reject the null hypothesis (i.e. the reduced model is a worse fit than the full model)

# Compare the AICs of the models
glm.AICs <- c(full_glm$aic, signifUni_glm$aic, signifFull_glm$aic)
names(glm.AICs) <- c('full_glm AIC:', 'signifUni_glm AIC:', 'signifFull_glm AIC:')
glm.AICs
  ## Result: signifUni_glm has the lowest AIC


# Further refine the model:
# use the step() function to search the model space with the lowest AIC
reduced_signifUni_glm <- step(signifUni_glm, trace=1)
# removed variables were:
  # Glucose_max
  # TroponinT_max
  # HCO3_min
  # RespRate_min
  # Weight_max
  # RespRate_max
  # Creatinine_max
summary(reduced_signifUni_glm)

# Compare the deviance of the further reduced model to signifUni_glm 
anova(reduced_signifUni_glm, signifUni_glm, test="Chisq") 
  ## Result: p value is not significant, the dropped parameters do not improve the fit of the model

```

1) *Full model* - a logistic model with all selected variables (excluding those with high degree of missingness) has been fitted. In the resulting fitted model, Age, ICUType, Albumin_min, Bilirubin_max, BUN_max, GCS_max, Temp_min, Urine_min, WBC_min and WBC_max are significant. These results do align with our brief EDA. The AIC of the model is 1323. <br>

2) *Significant on univariate model* - for parsimony, we look for a reduced model with fewer variables than can adequately explain the occurrence of in-hospital death for the ICU patient population. Our first attempt is to only include variables were significant in univariate logistic regression. Since the reduced model is nested in the full model, we use analysis of deviance to compare the two models. We accept the null hypothesis (p = 0.32) and conclude that the reduced model is a better fit to the data. This conclusion aligns with the models' respective AICs - the `signifUni_glm` model has a lower AIC of 1312. <br>

3) *Significant on full model* - the second attempt, reduces the full model again, this time by only including variables that were significant in the original full model itself. We again use the analysis of deviance to compare this model with the full model as the models are nested. We reject the null hypothesis (p = 0.004) and conclude that the full model is a better fit to the data. The AIC of this model (1321) is very similar to the full model (1323), however we do not continue to improve on the model as the significant analysis of deviance suggests we have excluded one or more important predictors. <br>

4) *Reduced significant on univariate variable model* - a further attempt to simplify this predictive model starts with the `signifUni_glm` model (number 2 in this list) and uses the step function to search the model space for a model with a better fit and fewer covariates. After 6 iterations, the reduced model includes 14 covariates. The variables: `Glucose_max`, `TroponinT_max`, `HCO3_min`, `RespRate_min`, `Weight_max`, `RespRate_max` and `Creatinine_max` were removed. When compared with the `signifUni_glm` model using analysis of deviance, the null hypothesis (p = 0.7) is accepted and we conclude that this reduced model is a better fit to the data than the `signifUni_glm` model. Furthermore, there is greater parsimony and the AIC is further reduced to 1302. <br>


### Final multivariable logistic regression model:

```{r task1.5}
# Choosing a final model
# Initially, start with a provisional final model 
# which is the same as the best-performing model above: reduced_signifUni_glm
finalICU_glm <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max
                    ,data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm) 


## Test some interactions based on clinical knowledge ##

# finalICU_glm_AgeCr = finalICU_glm + Age:Creatinine_max
finalICU_glm_AgeCr <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      
                      # interaction term  
                      Age:Creatinine_max # creatinine generally increases with age
                    , data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm_AgeCr)

# finalICU_glm_AgeTemp = finalICU_glm + Age:Temp_min
finalICU_glm_AgeTemp <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      
                      # interaction term  
                      Age:Temp_min # low temp more often associated with illness in the elderly e.g. cold sepsis
                    , data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm_AgeTemp)

# finalICU_glm_AgeWeight = finalICU_glm + Age:Weight_max 
finalICU_glm_AgeWeight <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      
                      # interaction term  
                      Age:Weight_max # weight generally decreases with age
                    , data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm_AgeWeight)

# finalICU_glm_AgeAlbumin = finalICU_glm + Age:Albumin_min
finalICU_glm_AgeAlbumin <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      
                      # interaction term  
                      Age:Albumin_min # albumin generally decreases with age
                    , data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm_AgeAlbumin) 

# finalICU_glm_AgeICUType = finalICU_glm + Age:ICUType
finalICU_glm_AgeICUType <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      
                      # interaction term  
                      Age:ICUType # age is likely to be related to ICU type 
                                  # e.g. elderly more likely to have poor outcome 
                                  # after surgery requiring post-op ICU support
                    , data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm_AgeICUType) 

# Analysis of deviance tests for the new models
lapply(list(finalICU_glm_AgeCr, finalICU_glm_AgeTemp, finalICU_glm_AgeWeight,
            finalICU_glm_AgeAlbumin, finalICU_glm_AgeICUType), 
       function(x) {print(anova(finalICU_glm, x, test="Chisq"))} )

## Result: borderline effect for age:albumin (p=0.054)
##         significant effect for age:icutype (p=0.016)


# Input the significant interactions into the model
finalICU_glm_interactions <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      
                      # significant interaction terms
                      Age:ICUType + Age:Albumin_min
                    , data=nm_icu_model_df1, family="binomial")
summary(finalICU_glm_interactions) 

# Examine the ORs and profiled 95% CIs
exp(coef(finalICU_glm_interactions))
exp(confint(finalICU_glm_interactions))
```

In order to further improve the model, we choose to test some interaction terms based on clinical/conceptual interactions between predictors. The tested interactions were `Age` with each of: `Creatinine_max`, `Temp_min`, `Weight_max`, `Albumin_min` and `ICUType.` Each interaction term was added one at a time and compared to the provisional 'final' model with analysis of deviance. The analysis of deviance revealed a significant interaction effect on the model of `Age:ICUType` (p = 0.016) and `Age:Albumin_min` (p = 0.054). Both terms were added to the provisional final model and the resulting model had a lower AIC again of 1297 (compared to 1302).


### Final model diagnostics:

```{r task1.6}
## Using the 'final' model = finalICU_glm_interactions: ##

### Goodness of fit using bins df1 ###

# add predicted probabilities to the data frame
nm_icu_model_df1 %>% mutate(predprob=predict(finalICU_glm_interactions, type="response"),
                   linpred=predict(finalICU_glm_interactions)) %>%
# group the data into bins based on the linear predictor fitted values
group_by(cut(linpred, breaks=unique(quantile(linpred, (1:50)/51)))) %>%
# summarise by bin
summarise(death_bin=sum(in_hospital_death), predprob_bin=mean(predprob), n_bin=n()) %>%
# add the standard error of the mean predicted probaility for each bin
mutate(se_predprob_bin=sqrt(predprob_bin*(1 - predprob_bin)/n_bin)) %>%
# plot it with 95% confidence interval bars
ggplot(aes(x=predprob_bin, 
           y=death_bin/n_bin, 
           ymin=death_bin/n_bin - 1.96*se_predprob_bin,
           ymax=death_bin/n_bin + 1.96*se_predprob_bin)) +
  geom_point() + geom_linerange(colour="orange", alpha=0.4) +
  geom_abline(intercept=0, slope=1) + 
  labs(x="Predicted probability (binned)",
       y="Observed proportion (in each bin)")
# the ideal calibration line fits within most of the dots and their 95% CI


### Goodness of fit using Hosmer Lemeshow stat ###

nm_icu_model_df1 %>% mutate(predprob=predict(finalICU_glm_interactions, type="response"),
                   linpred=predict(finalICU_glm_interactions)) %>%
group_by(cut(linpred, breaks=unique(quantile(linpred, (1:50)/51)))) %>%
summarise(death_bin=sum(in_hospital_death), predprob_bin=mean(predprob), n_bin=n()) %>%
mutate(se_predprob_bin=sqrt(predprob_bin*(1 - predprob_bin)/n_bin)) -> hl_df

hl_stat <- with(hl_df, sum( (death_bin - n_bin*predprob_bin)^2 /
                            (n_bin* predprob_bin*(1 - predprob_bin))))
hl <- c(hosmer_lemeshow_stat=hl_stat, hl_degrees_freedom=nrow(hl_df) - 1)
hl

# calculate p-value
c(p_val=1 - pchisq(hl[1], hl[2])) # the p value here is not statistically significant, indicating no lack of fit


### Brier score ###

get_brier <- function(model){
  predprob <- predict(model, type="response")
  Brier_score <- mean((predprob - nm_icu_model_df1$in_hospital_death)^2)
  return(Brier_score)
}

get_brier(finalICU_glm)
get_brier(finalICU_glm_interactions)

# the final model with interactions has slightly lower brier score -> lower score is better fit


### ROC Curve ###

# add the predicted probailities to the data frame
nm_icu_model_df1 %>% mutate(predprob=predict(finalICU_glm_interactions, type="response")) -> nm_icu_model_df1

# create multiple probability thresholds from 0.01 to 0.95
thresholds <- seq(0.01, 0.95, by=0.01)
# initialise sensitivities/specificities at the same length as thresholds vector
sensitivities <- numeric(length(thresholds))
specificities <- numeric(length(thresholds))

# for each probability threshold, run this loop
for (i in seq_along(thresholds)) {
  # assign yes or no - if predicted probability greater to threshold
  pp <- ifelse(nm_icu_model_df1$predprob < thresholds[i], "no", "yes")
  # create confusion matrix with respective in_hospital_death and pp values
  xx <- xtabs( ~ in_hospital_death + pp, data=nm_icu_model_df1)
  # calculate sens and spec for each threshold using confusion matrix values
  specificities[i] <- xx[1,1] / (xx[1,1] + xx[1,2])
  sensitivities[i] <- xx[2,2] / (xx[2,1] + xx[2,2])
}

# plot the ROC
plot(1 - specificities, sensitivities, type="l",
        xlab="1 - Specificity", ylab="Sensitivity", main='ROC curve of the final model',
        xlim=c(0,1), ylim=c(0,1))
abline(0,1, lty=2)

# calculate AUC
# sorts sensitivity and specificities into x and y coordinates
x <- sort(1-specificities)
y <- sort(sensitivities)

# use AUC function from {DescTools} package to calculate AUC
paste('The AUC is:', AUC(x,y))

```

Our multivariable logistic regression model for mortality of the imputed ICU dataset (icu_patients_df1) is based on initial variables selected due to known association with mortality either individually or as part of a validated ICU risk score (SOFA, SAPS1 and APACHE). Based on initial EDA, variables with a large proportion of missing data were excluded from the analysis (`Height`, `NISysABP_min`, `NISysABP_max`).

After analysing a series of fitted multivariable logistic regression models and exploring the effect of interaction terms, as explained above, we arrive at the final chosen model to predict in-hospital death in patients who have been admitted to ICU: `finalICU_glm_interactions`.

Goodness of fit of the chosen final model was explored using several methods. Firstly, we plot predicted probabilities in bins against the observed proportions in each bin to examine calibration. The plot shows sound calibration, with similar observed proportions and predicted probabilities, without any systematic deviation from the ideal calibration line. Further, almost all 95% CIs (except one) of each bin overlap the ideal calibration line, which suggests the model is realtively well-calibrated. The non-significant Hosmer-Lemeshow test (p=0.66) further supports no 'lack of fit' of the model, although this test is not without limitations and the choice of bins is arbitrary. The Brier score test (which does not rely on arbitrary bins) does further support the choice of the final model with interaction terms included (`finalICU_glm_interactions`) over the model without interaction terms (`finalICU_glm`), with the former having a marginally lower Brier score (0.102 vs 0.103) indicating greater predictive ability. Lastly, the predictive value of this model (`finalICU_glm_interactions`) was assessed by producing a ROC (receiver operating characteristic) curve. The ROC curve suggests moderate predictive ability of the model, with an AUC of 0.75 - indicating approximately a 75% chance of the model correctly predicting whether a patient will experience `in_hospital_death` after an ICU admission of >48 hours.

<br>

The pertinent characteristics of our predictive model suggests that in the first 24 hours of an ICU admission, higher `Albumin_min` (OR: 0.26, 95% CI: 0.08-0.77, p = 0.02), `GCS_max` (OR: 0.83, 95% CI: 0.80-0.87, p < 0.001), `Na_min` (OR: 0.96, 95% CI: 0.94-0.99, p = 0.006), `Temp_min` (OR: 0.85, 95% CI: 0.73-0.99, p = 0.04), `Urine_min` (OR: 0.99, 95% CI: 0.99-1.00 p = 0.02) and `WBC_max` (OR: 0.93, 95% CI: 0.89-0.97, p = 0.002) values **reduce** the odds of in-hospital death after an ICU admission of >48 hours; while higher `Bilirubin_max` (OR: 1.05, 95% CI: 1.02-1.08, p < 0.001), `BUN_max` (OR: 1.02, 95% CI: 1.01-1.02, p < 0.001), `HR_max` (OR: 1.01, 95% CI: 1.00-1.01, p = 0.02) and `WBC_min` (OR: 1.08, 95% CI: 1.03-1.14, p = 0.003) values **increase** the odds of in-hospital death after an ICU admission of >48 hours.

Based on the OR and profiled 95% CIs of these predictors of in-hospital death, in the first 24 hours of ICU admission, having a higher minimum albumin level and higher maximum GCS score reduce the odds of in-hospital death with relative certainty, while having a higher minimum white blood cell count increases the odds of in-hospital death in the ICU population.

Although these individual ORs provide some insights into the relative importance of different parameters, adequate overall prediction of in-hospital death after an ICU admission of >48 hours requires all of the predictor variables in the final model. Interestingly, age is not an individual predictor of in-hospital death using our model, although it remains important to include for the model's overall predictive capability.

As the goal of our model was predictive, there may be other important parameters that are required to better understand and explain in-hospital death after ICU admission, however our aim was to produce the simplest possible model to adequately predict the outcome of interest, hence some of these explanatory values may not be included.

<br>

Finally, it is important to note that as the outcome `in_hospital_death` was not uncommon in this dataset (297 deaths out of 2061 observations = 14.4%), the logistic regression output must be interpreted with caution. The listed ORs (odds ratios) must not be interpreted as RRs (risk ratios), as with a relatively common outcome (>10% observations), odds no longer estimates risk (it over-estimates risk). In further analysis, it may be useful to trial other types of regression to calculate RRs rather than ORs, such as log-binomial (although may encounter non-convergence with many predictors) or modified poisson regression.



### Re-fitting the model to the original data:

``` {r task1.7}
#### re-fit the final model to the unimputed data frame 
# (`icu_patients_df0.rds`) and comment on any differences you find 
# compared to the same model fitted to the data without imputation, 

df0_finalICU_glm_interactions <- glm(in_hospital_death ~ 
                      Age +
                      ICUType + 
                      Albumin_min + 
                      Bilirubin_max +
                      BUN_max + 
                      GCS_max + 
                      HR_max + 
                      Lactate_max + 
                      Na_min + 
                      pH_min + 
                      Temp_min + 
                      Urine_min + 
                      WBC_min + 
                      WBC_max +
                      Age:ICUType + Age:Albumin_min
                    , data=icu_patients_df0, family="binomial")
summary(df0_finalICU_glm_interactions) 
# when using the predictors from our final df1 model with interactions onto df0 data
# 1762 observations are removed due to missingness

# Examine ORs and profiled 95% CIs
exp(coef(df0_finalICU_glm_interactions))
exp(confint(df0_finalICU_glm_interactions))


```

When the final model was re-fitted to the the unimputed data (icu_patients_df0), we see that 1762 observations are removed due to missingness. This is because the default method used by `R` when attempting to fit a model to a dataset with missing data is to use only the observations with complete data (in this case, only 299 of the original 2061 observations had complete data).

Many of the variables that were significant when fitted to the imputed data, were no longer significant. Only four (compared to ten) predictors remained significant. The profiled 95% confidence intervals were also significantly wider, especially notable in the `ICUType` variable (upper CI up to nearly 70000!). Therefore, we see that the precision of the estimators in the model is much lower, due to the large amount of lost data to missingness. If one was to pursue using the original dataset with substantial missingness, it would be important to identify any patterns in the missing data to ensure potential sources of bias were identified and accounted for.

<br>


# Task 2 (15 marks)

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately explains or predicts the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a series of models, maybe three or four, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. Aim for between five and ten predictor variables (slightly more or fewer is OK). It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at least comment on the possible impact of what your diagnostics show). Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.


### Hints

1. Select an initial subset of explanatory variables that you will use to predict survival. Justify your choice.

2. Conduct basic exploratory data analysis on your variables of choice.

3. Fit appropriate univariate Cox proportional hazards models.

4. Fit an appropriate series of multivariable Cox proportional hazards models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them. 

7. Write a very brief paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation. 


## Task 2 Response:

### Select an initial subset of explanatory variables:

The purpose of this task is to understand the impact of information collected during the first 24 hours of an ICU stay on the length of survival of the ICU population (followed up for 2408 days, approximately 6.5 years).

To select an initial subset of explanatory variables, we used the same clinical logic as for Task 1 - to examine the measures used in already validated risk scores: SAPS1, SOFA and APACHE scores.
 
Therefore, the initial subset of explanatory variables we have chosen for this task are:

DEMOGRAPHIC VARIABLES: <br>
  * `Age`<br>
  * `Gender`<br>
  * `ICUType`<br>
  * `Height`<br>
  * `Weight_max`<br>
  * `Length_of_stay` <br><br>
  
CLINICAL VARIABLES: <br>
  * `Albumin_min`<br>
  * `Bilirubin_max`<br>
  * `BUN_max`<br>
  * `Creatinine_max`<br>  
  * `GCS_min`<br>
  * `Glucose_min` and `Glucose_max`<br>
  * `HCO3_min`<br>
  * `HR_min` and `HR_max`<br>
  * `K_min` and `K_max`<br>
  * `Lactate_max`<br>
  * `MAP_min`<br>
  * `Na_min` and `Na_max`<br> 
  * `NISysABP_min` and `NISysABP_max`<br> 
  * `Platelets_min`<br>
  * `FiO2_max` and `PaO2_min` - included as `PFratio`= `PaO2_min`/ `FiO2_max`<br>
  * `pH_min` and `pH_max`<br>
  * `RespRate_min` and `RespRate_max`<br>
  * `Temp_min` and `Temp_max`<br>
  * `TroponinI_max`<br>
  * `TroponinT_max`<br>
  * `Urine_min`<br>
  * `WBC_min` and `WBC_max`<br>


### Basic initial exploratory data analysis (EDA) and non-parametric survival curves:

```{r task 2.2.1}

# Outcome variables
unique_icu = unique(subset(icu_patients_df1, select = c(RecordID)))
dim(unique_icu) # There are 2061 unique individuals
table(icu_patients_df1$Status) #773 censored out of 2061 observations

# Plot KM survival curve (non-parametric)
ICU.fit <- survfit( Surv(Days, Status) ~ 1, data = icu_patients_df1) 
print(ICU.fit, print.rmean = TRUE)
#summary(ICU.fit)
plot(ICU.fit, main = 'Kaplan-Meier estimate of survival function', xlab = 'Length of survival (in days)')

# plotting Nelson-Aalen estimate (non-parametric)
plot(ICU.fit, fun="cumhaz", main = "Nelson-Aalen estimate of cumulative hazard function", xlab = 'Length of survival (in days)')

```

There were 773 deaths (out of 2061 participants) during follow-up.The median follow-up time cannot be determined as the survival rate has not yet dropped to 50% survival at the end of the available data. The cumulative hazard rate (as shown in the Nelson Aalen plot)  reaches 47% by the end of the available data.

```{r task 2.2.2, fig.width=20, fig.height=60} 

# Display frequencies for categorical explanatory variables
table(icu_patients_df1$Gender)
table(icu_patients_df1$ICUType)


# Display counts, histograms, median and IQRs for continuous explanatory variables

# Create PFratio variable:
icu_patients_df1$PFratio<-icu_patients_df1$PaO2_min/icu_patients_df1$FiO2_max

# Write a function for continuous variable EDA output
cont_eda <- function(variable){
    print(paste(variable,'EDA:'))
  
    na_rm <- na.omit(icu_patients_df1[,variable])
    neg_val<-icu_patients_df1[variable<0,variable]
    print(paste('Number of non-missing values:',length(na_rm)+length(neg_val))) # number of non-missing values
    print(paste('Number of missing values:',sum(is.na(icu_patients_df1[,variable])))) # number of missing values
  
    print(quantile(icu_patients_df1[,variable], na.rm=TRUE))
    hist(icu_patients_df1[,variable], breaks=20, xlab=variable, main=paste('Histogram of',variable))
}

# Loop through the continuous variables from the chosen list of variables to explore and pass them to the EDA function
 cont_vars <- c('Age', 'Length_of_stay', 'Height', 'Weight_max', 'Albumin_min', 'Bilirubin_max', 
                'BUN_max', 'Creatinine_max', 'GCS_min', 'Glucose_min', 
                'Glucose_max', 'HCO3_min', 'HR_min', 'HR_max', 'K_min', 'K_max', 
                'Lactate_max', 'MAP_min', 'Na_min', 'Na_max', 'NISysABP_min', 
                'NISysABP_max', 'Platelets_min', 'PFratio', 'pH_min', 'pH_max', 
                'RespRate_min', 'RespRate_max', 'Temp_min', 'Temp_max', 
                'TroponinI_max', 'TroponinT_max', 'Urine_min', 'WBC_min', 'WBC_max')


par(mfrow=c(12,3)) # set the layout of the histograms in 12 row x 3 column grid
for(i in 1:length(cont_vars)){
  cont_eda(cont_vars[i])
}

#Check negative values in 
neg_val<-icu_patients_df1[icu_patients_df1$Length_of_stay<0,"Length_of_stay"]
length(neg_val)
```

**EDA Findings:**

* There are 2061 unique individuals in the dataset. Of these, 913 are female (44%) and 1148 are male (56%).
* Medical ICU accounted for 38% of individuals, 26% in Surgical ICU, 24% in Cardiac Surgery recovery Unit and 14% in the Coronary Care unit.

* The following variables have a large proportion of missing observations:
    * `Weight_max` - 146 missing observations
    * `Height` - 992 missing observations
    * `NISysABP_min` & `NISysABP_max` - 453 missing observations
    * `Length_of_stay` - 25 negative values
    
* The median values (50% quantile) and IQR (25% - 75% quantiles) are displayed for all continuous variables.



```{r task 2.2.3}
#Plot the Kaplan-Meier survival curves by categorical variables in the data

#Gender
ICU.gender.fit <- survfit( Surv(Days, Status) ~ as.factor(Gender), data = icu_patients_df1) 
print(ICU.gender.fit, print.rmean = TRUE)
plot(ICU.gender.fit, col=c("blue", "red"), main = 'Kaplan-Meier estimate of survival function', xlab = 'Length of survival (in days)')
legend("bottomleft", legend=c("Female", "Male"),col=c("blue","red"), lty=1:1,cex=1)

#ICUType
ICU.type.fit <- survfit( Surv(Days, Status) ~ as.factor(ICUType), data = icu_patients_df1) 
print(ICU.type.fit, print.rmean = TRUE)
plot(ICU.type.fit, col=c("blue", "red","purple","green"), main = 'Kaplan-Meier estimate of survival function', xlab = 'Length of survival (in days)')
legend("bottomleft", legend=c("Coronary Care Unit", "Cardiac Surgery Recovery Unit", "Medical ICU", "Surgical ICU"),col=c("blue","red","purple","green"), lty=1:1,cex=1)

```

The survival curves above show that risk of mortality is greater for the ICU population that is female than those that are male. Furthermore, ICU population mortality by ICU Type is different - those in Medical ICU have the highest risk of mortality whereas those in Cardiac Surgery Recovery Unit have the lowest. Interestingly, the survival curves look parallel for each category indicating Cox proportional hazards model is an appropriate model for ICU related survival.


### Univariate Cox proportional hazards models:

```{r task2.3.1}

# Cox proportional models and Log Rank tests for the chosen variables
# Survival object = Surv(Days, Status)

# Gender
ICU.fitbyGender <- coxph( Surv(Days, Status) ~ as.factor(Gender), data = icu_patients_df1) 
summary(ICU.fitbyGender)

# ICU Type
ICU.fitbytype <- coxph( Surv(Days, Status) ~ as.factor(ICUType), data = icu_patients_df1) 
summary(ICU.fitbytype)

# Age
ICU.fitbyage <- coxph( Surv(Days, Status) ~ Age, data = icu_patients_df1) 
summary(ICU.fitbyage)

# Length_of_stay
ICU.fitbyLoS <- coxph( Surv(Days, Status) ~ Length_of_stay, data = icu_patients_df1) 
summary(ICU.fitbyLoS)

# Height
ICU.fitbyheight <- coxph( Surv(Days, Status) ~ Height, data = icu_patients_df1) 
summary(ICU.fitbyheight)

# Weight_max
ICU.fitbyweightmax <- coxph( Surv(Days, Status) ~ Weight_max, data = icu_patients_df1) 
summary(ICU.fitbyweightmax)

# Albumin_min
ICU.fitbyAlbuminmin <- coxph( Surv(Days, Status) ~ Albumin_min, data = icu_patients_df1) 
summary(ICU.fitbyAlbuminmin)

# Bilirubin_max
ICU.fitbyBilirubinmax <- coxph( Surv(Days, Status) ~ Bilirubin_max, data = icu_patients_df1) 
summary(ICU.fitbyBilirubinmax)

# BUN_max
ICU.fitbyBUNmax <- coxph( Surv(Days, Status) ~ BUN_max, data = icu_patients_df1) 
summary(ICU.fitbyBUNmax)

# Creatinine_max
ICU.fitbyCreatininemax <- coxph( Surv(Days, Status) ~ Creatinine_max, data = icu_patients_df1) 
summary(ICU.fitbyCreatininemax)

# GCS_min
ICU.fitbyGCSmin <- coxph( Surv(Days, Status) ~ GCS_min, data = icu_patients_df1) 
summary(ICU.fitbyGCSmin)

# Glucose - min & max
ICU.fitbyGlucosemin <- coxph( Surv(Days, Status) ~ Glucose_min, data = icu_patients_df1) 
summary(ICU.fitbyGlucosemin)
ICU.fitbyGlucosemax <- coxph( Surv(Days, Status) ~ Glucose_max, data = icu_patients_df1) 
summary(ICU.fitbyGlucosemax)

# HCO3_min
ICU.fitbyHCO3min <- coxph( Surv(Days, Status) ~ HCO3_min, data = icu_patients_df1) 
summary(ICU.fitbyHCO3min)

# HR - min & max
ICU.fitbyHRmin <- coxph( Surv(Days, Status) ~ HR_min, data = icu_patients_df1) 
summary(ICU.fitbyHRmin)
ICU.fitbyHRmax <- coxph( Surv(Days, Status) ~ HR_max, data = icu_patients_df1) 
summary(ICU.fitbyHRmax)

# K - min & max
ICU.fitbyKmin <- coxph( Surv(Days, Status) ~ K_min, data = icu_patients_df1) 
summary(ICU.fitbyKmin)
ICU.fitbyKmax <- coxph( Surv(Days, Status) ~ K_max, data = icu_patients_df1) 
summary(ICU.fitbyKmax)

# Lactate_max
ICU.fitbyLactatemax <- coxph( Surv(Days, Status) ~ Lactate_max, data = icu_patients_df1) 
summary(ICU.fitbyLactatemax)

# MAP_min
ICU.fitbyMAPmin <- coxph( Surv(Days, Status) ~ MAP_min, data = icu_patients_df1) 
summary(ICU.fitbyMAPmin)

# Na - min & max
ICU.fitbyNamin <- coxph( Surv(Days, Status) ~ Na_min, data = icu_patients_df1) 
summary(ICU.fitbyNamin)
ICU.fitbyNamax <- coxph( Surv(Days, Status) ~ Na_max, data = icu_patients_df1) 
summary(ICU.fitbyNamax)

# NISysABP - min & max
ICU.fitbyNISysABPmin <- coxph( Surv(Days, Status) ~ NISysABP_min, data = icu_patients_df1) 
summary(ICU.fitbyNISysABPmin)
ICU.fitbyNISysABPmax <- coxph( Surv(Days, Status) ~ NISysABP_max, data = icu_patients_df1) 
summary(ICU.fitbyNISysABPmax)

# Platelets_min
ICU.fitbyPlateletsmin <- coxph( Surv(Days, Status) ~ Platelets_min, data = icu_patients_df1) 
summary(ICU.fitbyPlateletsmin)

# PFratio (PaO2_min/FiO2_max)
ICU.fitbyPFratio <- coxph( Surv(Days, Status) ~ PFratio, data = icu_patients_df1) 
summary(ICU.fitbyPFratio)

# pH - min & max
ICU.fitbypHmin <- coxph( Surv(Days, Status) ~ pH_min, data = icu_patients_df1) 
summary(ICU.fitbypHmin)
ICU.fitbypHmax <- coxph( Surv(Days, Status) ~ pH_max, data = icu_patients_df1) 
summary(ICU.fitbypHmax)

# RespRate - min & max
ICU.fitbyRespRatemin <- coxph( Surv(Days, Status) ~ RespRate_min, data = icu_patients_df1) 
summary(ICU.fitbyRespRatemin)
ICU.fitbyRespRatemax <- coxph( Surv(Days, Status) ~ RespRate_max, data = icu_patients_df1) 
summary(ICU.fitbyRespRatemax)

# Temp - min & max
ICU.fitbyTempmin <- coxph( Surv(Days, Status) ~ Temp_min, data = icu_patients_df1) 
summary(ICU.fitbyTempmin)
ICU.fitbyTempmax <- coxph( Surv(Days, Status) ~ Temp_max, data = icu_patients_df1) 
summary(ICU.fitbyTempmax)

# Troponin_max (I and T assays)
ICU.fitbyTroponinImax <- coxph( Surv(Days, Status) ~ TroponinI_max, data = icu_patients_df1) 
summary(ICU.fitbyTroponinImax)
ICU.fitbyTroponinTmax <- coxph( Surv(Days, Status) ~ TroponinT_max, data = icu_patients_df1) 
summary(ICU.fitbyTroponinTmax)

# Urine_min
ICU.fitbyUrinemin <- coxph( Surv(Days, Status) ~ Urine_min, data = icu_patients_df1) 
summary(ICU.fitbyUrinemin)

# WBC - min & max
ICU.fitbyWBCmin <- coxph( Surv(Days, Status) ~ WBC_min, data = icu_patients_df1) 
summary(ICU.fitbyWBCmin)
ICU.fitbyWBCmax <- coxph( Surv(Days, Status) ~ WBC_max, data = icu_patients_df1) 
summary(ICU.fitbyWBCmax)


```

**Univariable Cox model interpretation by Variable:**

* `Gender` - non-significant log-rank test (p-value = 0.06), means that the null hypothesis of no difference in survival between genders is not rejected with a conclusion that survival does not significantly differ by gender.
* `ICUType` - significant log-rank test (p-value close to 0), means that the null hypothesis is rejected with a conclusion that survival significantly differs by each ICU Type. Note that, hazard rate for those in Medical ICU is not statistically significantly different for those in Coronary Care Unit.
* `Age` - significant log-rank test (p-value close to 0), means that the null hypothesis is rejected with a conclusion that survival significantly differs by individual's age. For every year older in age, the risk of mortality increases by approximately 3%.
* `Length_of_stay` - significant log-rank test (p-value = 0.000005), means that the null hypothesis is rejected with a conclusion that survival significantly differs by individual's length of stay in hospital. For every extra day in hospital, the risk of mortality increases by approximately 1%.
* `Height` - non-significant log-rank test (p-value = 0.1), means that the null hypothesis of no difference in survival for varying heights is not rejected with a conclusion that survival does not significantly differ by height.
* `Weight_max` - significant log-rank test (p-value = 0.00004) indicating that the null hypothesis is rejected with a conclusion that survival significantly differs by weight. For every additional kilogram, the risk of mortality reduces by approximately 1%. The use of a centered variable may make it easier to interpret.

* Clinical measures where the log-rank test results in a rejection of the null hypothesis (p-value <0.05) arguing for the variables' significance in predicting survival times are:
  * `Albumin_min`
  * `Bilirubin_max`
  * `Creatinine`
  * `BUN_max`
  * `Creatinine_max`
  * `Glucose_max`
  * `HCO3_min`
  * `K_max`
  * `Lactate_max`
  * `MAP_min`
  * `Na_min`
  * `NISysABP_min` & `NISysABP_max` 
  * `pH_min` & `pH_max` 
  * `RespRate_min` & `RespRate_max` 
  * `Temp_min` & `Temp_max` 
  * `TroponinT_max`
  * `Urine_min`  

### Multivariable Cox proportional hazards models:

```{r task 2.4.1}

## As in Task 1, create a dataset without missing or invalid data to use to build the model ##
## in order to remain consistent and allow comparisons between models to be made ##


 # Check counts of missing data in each variable
 for(i in 1:length(colnames(icu_patients_df1))){
   print(c(i,colnames(icu_patients_df1[i]), sum(is.na(icu_patients_df1[i]))))
 }
 ## Result: of the variables chosen to explore for the survival model, large amounts of missing data in:
 ##         Height (992), NISysABP_min (453), NISysABP_max (453), Weight_max (146)
 
 ## Decision: include Weight_max; remove Height, NISysABP_min, NISysABP_max
 
 
 # Check counts of negative data (noted some -1 values) in each variable
 for(i in 1:length(colnames(icu_patients_df1))){
   print(c(i,colnames(icu_patients_df1[i]), sum(icu_patients_df1[i] < 0)))
 }
 ## Result: negative values in Length_of_stay and SOFA (not listed in initial choice of variables)


 # Create a new dataset with the only non-missing data from list of initial variables chosen
 # (excluding those with very high missingness i.e. Height, NISysABP_min, NISysABP_max)
 nm_icu_model_df1 <- na.omit(subset(icu_patients_df1, 
                                    select=c(Days, Status, # the survival object variables
                                             RecordID, # keep record id for reference if needed
                                             in_hospital_death, # from task 1
                                             Age, Length_of_stay, Gender, ICUType, Weight_max,
                                             Albumin_min, Bilirubin_max,
                                             BUN_max, Creatinine_max, 
                                             GCS_max, Glucose_min, Glucose_max, 
                                             HCO3_min, HR_min, HR_max, K_min, 
                                             K_max, Lactate_max, MAP_min, Na_min,
                                             Na_max, Platelets_min, PFratio, pH_min,
                                             pH_max, RespRate_min, RespRate_max,
                                             Temp_min, Temp_max, TroponinT_max, 
                                             TroponinI_max, Urine_min, WBC_min, WBC_max)))

 dim(nm_icu_model_df1)
 
# Also exclude the negative data in Length_of_stay 
 nm_icu_model_df1<-nm_icu_model_df1[nm_icu_model_df1$Length_of_stay>=0,]
 dim(nm_icu_model_df1)
 
```

Due to the high degree of missingness, `NISysABP_min`,  `NISysABP_max` and `Height` variables will be excluded from the multivariate modelling. The negative values of `Length_of_stay` are also removed. After removing missing and negative values, the resulting dataset used to fit multivariable models has 1891 observations.


```{r task 2.4.2 }
## Fitting multivariable models ##


# Create a function to calculate AIC
calc_aic <- function(model){
  AIC <- 2*length(model$coefficients)-2*model$loglik[2]
}


# Full model using all listed initial variables (excluding those with high missingness)
ICU.mv_full <- coxph(Surv(Days, Status) ~ 
                    Age + Length_of_stay + Gender + ICUType + Weight_max + Albumin_min + Bilirubin_max +
                    BUN_max + Creatinine_max + GCS_max + Glucose_min + Glucose_max + 
                    HCO3_min + HR_min + HR_max + K_min + K_max + Lactate_max + MAP_min + 
                    Na_min + Na_max + Platelets_min + PFratio + pH_min + pH_max + 
                    RespRate_min + RespRate_max + Temp_min + Temp_max + TroponinT_max + 
                    TroponinI_max + Urine_min + WBC_min + WBC_max,
                    data = nm_icu_model_df1)
summary(ICU.mv_full)

# Calculate full model AIC
AIC.mv_full <- calc_aic(ICU.mv_full)
AIC.mv_full


# 1st reduced model using all variables with significant log-rank tests
ICU.mv_reduced1 <- coxph(Surv(Days, Status) ~
                        Age + Length_of_stay + ICUType + Weight_max + Albumin_min + Bilirubin_max +
                        BUN_max + Creatinine_max + Glucose_max + HCO3_min + 
                        K_max + Lactate_max + MAP_min + Na_min + pH_min + 
                        pH_max + RespRate_min + RespRate_max + Temp_min + 
                        Temp_max + TroponinT_max + Urine_min,
                        data = nm_icu_model_df1)
summary(ICU.mv_reduced1)

# Calculate 1st reduced model AIC
AIC.mv_reduced1 <- calc_aic(ICU.mv_reduced1)
AIC.mv_reduced1


# 2nd reduced model using all variables significant (using cut off p < 0.1) in ICU.mv_reduced1
# (note using p < 0.1 gained better results than p < 0.05 as a cut off)
ICU.mv_reduced2 <- coxph(Surv(Days, Status) ~
                        Age + Length_of_stay + ICUType + Albumin_min + Bilirubin_max + BUN_max + 
                        HCO3_min + Lactate_max + Na_min + pH_min + 
                        RespRate_max + Urine_min,
                        data = nm_icu_model_df1)
summary(ICU.mv_reduced2)

# Calculate 2nd reduced model AIC
AIC.mv_reduced2 <- calc_aic(ICU.mv_reduced2)
AIC.mv_reduced2 


# 3rd reduced model by using step() function on the full model (which had the lowest AIC so far)
ICU.mv_reduced3 <- step(ICU.mv_full, trace=1)
summary(ICU.mv_reduced3)
## Interestingly: GCS_max, HR_min & Na_max have worked their way back in (not significant on log-rank)

# Calculate 3rd reduced model AIC
AIC.mv_reduced3 <- calc_aic(ICU.mv_reduced3)
AIC.mv_reduced3 


# 4th reduced model using significant variables (using cut off p < 0.05) from ICU.mv_reduced3 
ICU.mv_reduced4 <- coxph(Surv(Days, Status) ~
                        Age + ICUType + Albumin_min + Bilirubin_max + BUN_max + 
                        GCS_max + HCO3_min + HR_min + Lactate_max + Na_max + 
                        pH_min + Temp_max + Urine_min,
                        data = nm_icu_model_df1)
summary(ICU.mv_reduced4)

# Calculate 4th reduced model AIC
AIC.mv_reduced4 <- calc_aic(ICU.mv_reduced4)
AIC.mv_reduced4 


# Comparing models with LRT
lapply(list(ICU.mv_reduced1, ICU.mv_reduced2, ICU.mv_reduced3, ICU.mv_reduced4), 
       function(reduced) {print(anova(ICU.mv_full, reduced))} )
## Results: reduced1 and reduced2 - reject the null hypothesis that the reduced models are better (they are worse)
##          reduced3 and reduced4 - DONT reject the null hypothesis 
##                                    --> therefore the reduced models are better than the full model (matches our AICs)


# Print the AICs all together to review
aic_output <- c(AIC.mv_full, AIC.mv_reduced1, AIC.mv_reduced2, AIC.mv_reduced3, AIC.mv_reduced4)
names(aic_output) <- c('Full AIC:', 'Reduced 1 AIC:', 'Reduced 2 AIC:', 'Reduced 3 AIC:', 'Reduced 4 AIC:')
print(aic_output)

## Decision: use ICU.mv_reduced4 as the provisional final model (lowest AIC and non-significant LRT)

# Compare LRT for 3rd and 4th reduced models
anova(ICU.mv_reduced3, ICU.mv_reduced4)

```

**Selecting a multivariable Cox proportional hazards model:**

1) *Full model* - a model with all selected variables (excluding those with high degree of missingness) has been fitted. In the resulting fitted model, Age, ICU type, BUN_max, GCS_max, are highly significant. Lactate_max, pH_min, Temp_max and urine_min are also significant at 5% significance level. Furthermore, Albumin_min, Bilirubin_max, HCO3_min, HR_min, WBC_min and WBC_max are significant at 10% significance level. The resulting model has a maximised likelihood of 521.9. The log rank test statistic is highly significant (p-value close to 0), indicating that the variables in the full model have significant explanatory power on ICU population survival. Note, the AIC of the full model is 10,069. <br>

2) *Reduced Model 1* - for parsimony, we look for a reduced model with fewer variables than can adequately explain survival rates for the ICU population. Our first attempt is to only include variables that resulted in a significant log rank test for the respective univariate models. Since the reduced model is nested in the full model, we use a likelihood ratio test to compare the two model. We reject the null hypothesis (p-value is 2.139e-09) and conclude that the full model is a better fit to the data. This conclusion is echoed when comparing the models' AICs - the reduced model has a higher AIC of 10,111. <br>

3) *Reduced Model 2* - the second attempt, reduces the Reduced Model 1 by only including variables that were significant at a 10% significance level. We can again use a likelihood ratio test to compare this model with the full model as the models are nested. We reject the null hypothesis (p-value is 1.701e-08) and conclude that the full model is a better fit to the data. Whilst the AIC for Model 2 (10,105) is lower than for Model 1, it is higher than the Full Model, which leads to the same conclusion as the LRT test. <br>

4) *Reduced Model 3* - the third attempt starts with the full model and uses the step function to search the model space for a model with a better fit and fewer covariates. After 17 iterations, the reduced model includes 18 covariates. Interestingly, GCS_max, HR_min & Na_max are now being included in the model despite the non-significant log rank tests for the univariate models. When compared with the full model,  the null hypothesis of the LRT test (p-value = 0.94)is accepted and we can conclude that the reduced model is a better fit to the data than the full model. Furthermore, the AIC is reduced to 10,047. <br>

5) *Reduced Model 4* - in this model, we take Model 3 and only include the significant variables at 5% significance level (i.e. removed Weight_max, RespRate_min, respRate_max, WBC_min, WBC_max). When compared with the full model,  the null hypothesis of the LRT test (p-value = 0.51) is accepted and we can conclude that the reduced model is a better fit to the data than the full model. Furthermore, the AIC is 10,047 similar to the AIC for Reduced Model 3. The LRT when comparing Model 3 and 4 does not reject the null hypothesis concluding that Model 4 is a better fit than Model 3.  <br>

Hence, we choose Model 4 as the final selection of covariates for the multivariable Cox model. 


### Cox proportional hazards model assumption checking:

```{r task 2.4.3}
## Testing assumptions ##

# Testing for proportional hazards assumption of ICU.mv_reduced4 using cox.zph()
cox.zph(ICU.mv_reduced4, terms=FALSE)
## Result: statistically significant global test, therefore the proportional hazards model is violated
##         (the variables that violate are: ICUType, Albumin_min, Bilirubin_max, GCS_max, HCO3_min, HR_min, Lactate_max)


# Including time x covariate interactions to fix proportional hazards for problematic variables

# Split the dataset at 90 days (~ 3 months)
# Suspect there may be some systematic differences in patients who survive less than or greater than 3 months after ICU admission
ICU.split <- survSplit(Surv(Days, Status) ~ ., data = nm_icu_model_df1, cut=c(90), episode= "tgroup", id="id2")
head(ICU.split)

# Fit the model with time x covariate interactions
ICU.mv_reduced4.split <- coxph(Surv(Days, Status) ~
                                Age + ICUType:strata(tgroup) + 
                                Albumin_min:strata(tgroup) + 
                                Bilirubin_max:strata(tgroup) + BUN_max + 
                                GCS_max:strata(tgroup) + HCO3_min:strata(tgroup) + 
                                HR_min:strata(tgroup) + 
                                Lactate_max:strata(tgroup) + Na_max + pH_min + 
                                Temp_max + Urine_min,
                                data = ICU.split)
summary(ICU.mv_reduced4.split)

# evaluating the proportional hazards assumption again, for the model with time x covariate interactions
cox.zph(ICU.mv_reduced4.split, terms=FALSE)
## Result: the global test is now insignificant (p = 0.07)


# Checking Linearity by observing Martingale residuals

# Refit the chosen model with any factor variables re-coded as numeric 
# to allow the ggcoxfunctional() function to work
ICU.mv_reduced4.nofactor <- coxph(Surv(Days, Status) ~
                                  Age + as.numeric(ICUType) + Albumin_min + Bilirubin_max + BUN_max + 
                                  GCS_max + HCO3_min + HR_min + Lactate_max + Na_max + 
                                  pH_min + Temp_max + Urine_min,
                                  data = nm_icu_model_df1)
ggcoxfunctional(ICU.mv_reduced4.nofactor, nm_icu_model_df1)
## Result: Some observations with non-linear residuals, particularly in the extremes of that value


# Check linearity of the model as a whole
ggcoxdiagnostics(ICU.mv_reduced4, type = "martingale", linear.predictions = FALSE, ggtheme = theme_bw()) 
## Result: appears reasonably linear with with 2 large negative outliers 
##         (large negative interpretation = 'lived too long')

# Examine the observations with very large negative residuals (< -3)
resid(ICU.mv_reduced4)[resid(ICU.mv_reduced4) < -3]
icu_patients_df1[c(1511,1929),]
## Interpretation: looks like they were relatively elderly with long lengths of stay
##                - one had low GCS values/high SAPS1/high lactate
##                - the other had high bilirubin/deranged LFTs/high lactate

## Decision: remove these outliers and re-fit the model to the dataset excluding these observations -->

# Check the RecordIDs match up with the correct data in the non-missing, split dataset
ICU.split[(ICU.split$RecordID == 136398 | ICU.split$RecordID == 137433),]

# Remove these observations and save as new dataset
ICU.split_noutliers <- ICU.split[!(ICU.split$RecordID %in% c(136398, 137433)),]

# Refit the split model to the new dataset
ICU.mv_reduced4.split.noutliers <- coxph(Surv(Days, Status) ~
                                          Age + ICUType:strata(tgroup) + 
                                          Albumin_min:strata(tgroup) + 
                                          Bilirubin_max:strata(tgroup) + BUN_max + 
                                          GCS_max:strata(tgroup) + HCO3_min:strata(tgroup) + 
                                          HR_min:strata(tgroup) + 
                                          Lactate_max:strata(tgroup) + Na_max + pH_min + 
                                          Temp_max + Urine_min,
                                          data = ICU.split_noutliers)
summary(ICU.mv_reduced4.split.noutliers)

# Calculate the split/no outlier model AIC
AIC.mv_reduced4.split.noutliers <- calc_aic(ICU.mv_reduced4.split.noutliers)
AIC.mv_reduced4.split.noutliers 

## Decision: use the 4th reduced model, split at time 3 months (90 days) on the split dataset with the outliers removed as the final dataset

# Difference in Coefficients
ICU.mv_reduced4.split.noutliers$coefficients
ICU.mv_reduced4.split$coefficients

```

We need to test whether the chosen model satisfies the assumptions underlying the Cox Proportional Hazards model. 

1) Testing for proportional hazards assumption

* Proportional hazard assumption is supported by a non-significant relationship between residuals and time, while a significant relationship favours the null of non-constant hazards. 

* The output from the proportional hazards test shows that the test is statistically significant (p-value < 0.05) for `ICUType`, `Albumin_min`, `Bilirubin_max`, `GCS_max`, `HCO3_min`, `HR_min` and `Lactate_max`. The global test is also statistically significant (p-value is very small = 1.6e-12). Therefore, there appears to be a violation of the proportional hazards model.

* We choose to address the violations of the proportional hazards assumption by including time x covariate interactions in the model for the variables that violated the proportional hazards assumption. By looking at the survival curve and the assumption that there may be systematic differences in patients who survive less than or greater than 3 months after ICU admission, we choose a post ICU survival time of 90 days.

* The hazard rate increases at varying rates for the population who survived less than 90 days. Looking at the exponential of the coefficients gives us an estimate of the hazard rate related to each covariate.
    * `ICUType` - the reference group is those in Surgical ICU. Those in Medical ICU are 21.6% more likely to die than those is surgical ICU within the first 90 days.  For those who survive the first 90 days, this risk increases to 75.4%. For those in Cardiac SUrgery Recovery Unit, the risk is 70% lower than Surgical ICU for those who survive less than 90 days. This changes to 30% lower than risk for Surgical ICU for those who survive more than 90 days.
    * `Albumin_min` - for every additional unit of Albumin, the risk of mortality is  22% lower for those that die within the first 90 days. For those that survive more than 90 days, the risk of mortality does not significantly differ by level of Albumin  as the confidence interval for the second period includes the value 1.
    * `Bilirubin_max` - the impact on mortality risk is not significant for either time period as the confidence interval includes 1.
    * `GCS_max` - for every additional unit of GCS, the mortality risk is reduced significantly in both periods. For the first 90 days,  the risk is reduced by 12%. For the subsequent period, the risk is reduced by 7%.
    * `HCO3_min` - for the first time period (< 90 days) there is no significant difference in mortality risk by level of HCO3. However, in the subsequent period, every additional unit of HCO3 results in an increased mortality by 4%.
    * `HR_min` - for every additional 10 beats per minute, there is a 8% increase in mortality for those that die within the first 90 days. The difference is not significant for patients who survive more than 90 days.
    * `Lactate` - for every additional unit of Lactate, there us 9% increase in mortality risk for those who die within the first 90 days. The difference is not significant for the subsequent period.

* Allowing the regression coefficients to differ in the two time intervals (before 90 days and after) has helped address the violation of the PH assumption. The global test for our model is no longer significant (p-value =0.07).


2) Check linearity by observing Martingale residuals for continuous variables

* None of the martingale residual plots look particularly flat around the zero point and this could be a result of scale on the plot, the residuals are quite small in size compared to the observed values of the covariates.
* Many plots show residuals clustered around certain values of the covariate, which makes the fitted loess curves of resiudals (black smooth lines) difficult to interpret. These values are typical measures of the variable (e.g. ph of 7, temperature of 37 degrees). AS expected, there would be very few (if any) real observations in the extreme ranges of the variables.


3) Checking linearity for the model as a whole

* The overall model residuals appear reasonably linear around 0. However, we do observe 2 very large negative outliers (individuals whose actual survival time was significantly greater than estimated by the model.  On closer observation, these 2 individuals were relatively elderly with long lengths of stay in hospital. One had low GCS values, high SAPS1, high lactate whilst the other had high bilirubin, deranged LFTs and high lactate, all indicators of high risk of mortality.

* We have removed these outliers observations and re-fit the model to the dataset excluding these observations. The model fit has improved (with AIC now 9,993 compared to 10,047). The resulting changes in coefficient estimates are insignificant.


### Final multivariable Cox proportional hazards model:

```{r task2.5}

# The final model chosen after checking and addressing assumptions
# (the same model as above: ICU.mv_reduced4.split.noutliers)
ICU.final.cox <- coxph(Surv(Days, Status) ~
                         Age + ICUType:strata(tgroup) + 
                         Albumin_min:strata(tgroup) + 
                         Bilirubin_max:strata(tgroup) + BUN_max + 
                         GCS_max:strata(tgroup) + HCO3_min:strata(tgroup) + 
                         HR_min:strata(tgroup) + Lactate_max:strata(tgroup) + 
                         Na_max + pH_min + Temp_max + Urine_min,
                         data = ICU.split_noutliers)
summary(ICU.final.cox)

```

* The estimated coefficients, related hazard rates (exponential of these coefficients) and the confidence interval of the hazard rates allow us to make some conclusions about clinical measures in the first 24 hours of ICU admission, and their impact on overall survival.
    * `Age` - for every additional year of survival, the difference in mortality risk is significant, increasing by 3.5% with a 95% confidence that this increase could range between 2.95% and 4.07% per year.
    * `BUN_max` - for every additional unit of maximum urea, difference in mortality risk is significant, increasing by 1.1% (95% confidence between 0.8% and 1.4%).
    * `Na_max` - for every additional unit of maximum sodium, difference in mortality risk is significant, decreasing by 4% (95% confidence between 3.5% and 5.5%).
    * `pH_min` - for every additional unit of minimum pH, risk of mortality decreases in 35% but the 95% confidence interval is large, ranging between a reduction of 4% and 55%). This could be due to the sensitivity of the measure as humans are highly unlikely to increase or decrease pH by 1 whole unit (normal pH range is narrow: 7.35-7.45).
    * `Temp_max` - for every additional unit of maximum temperature, mortality risk decreases by 15% (95% confidence interval between 5% and 23%).
    * `Urine_max` - for every additional 10mL of maximum urine output, the risk of mortality decreases by 2% (confidence interval between 0% and 4%).
    
* As mentioned earlier, the variables which have been split into 2 time periods produce the following insights:
    * `ICUType` - the reference group is those in Surgical ICU. Those in Medical ICU are 21.6% more likely to die than those in surgical ICU within the first 90 days.  For those who survive the first 90 days, this risk increases to 75.4%. For those in Cardiac Surgery Recovery Unit, the risk is 70% lower than Surgical ICU for those who survive less than 90 days. This changes to 30% lower than risk for Surgical ICU for those who survive more than 90 days.
    * `Albumin_min` - for every additional unit of minimum albumin, the risk of mortality is 22% lower for those that die within the first 90 days. For those that survive more than 90 days, the risk of mortality does not significantly differ by level of Albumin as the confidence interval for the second period includes the value 1.
    * `Bilirubin_max` - the impact on mortality risk is not significant for either time period as the confidence interval includes 1.
    * `GCS_max` - for every additional unit of maximum GCS score, the mortality risk is reduced significantly in both periods. For the first 90 days, the risk is reduced by 12%. For the subsequent period, the risk is reduced by 7%.
    * `HCO3_min` - for the first time period (< 90 days) there is no significant difference in mortality risk by minimum level of HCO3. However, in the subsequent period, every additional unit of minimum HCO3 results in an increased mortality by 4%.
    * `HR_min` - for every additional 10 beats per minute in the minimum recorded HR, there is a 8% increase in mortality for those that die within the first 90 days. The difference is not significant for patients who survive more than 90 days.
    * `Lactate_max` - for every additional unit of maximum lactate, there us 9% increase in mortality risk for those who die within the first 90 days. The difference is not significant for the subsequent period.
    
    
### Final model diagnostics:

```{r task2.6}

# PH test
cox.zph(ICU.final.cox, terms=FALSE)

# Graph of Schoenfeld residuals
ggcoxdiagnostics(ICU.final.cox, type = "schoenfeld", title = "Diagnostic plot")

```

**Final Model Diagnostics:**

1) Proportional Hazards Assumptions
* Proportional hazard assumption is supported by a non-significant relationship between residuals and time, while a significant relationship favours the null of non-constant hazards. The global test on the final model is not statistically significant (p-value is 0.08). Therefore, there does not appear to be a violation of the proportional hazards assumption.

* The output from the proportional hazards test shows that the test is statistically significant at a 5% significance level for `GCS_max`, `HCO3_min`, and `Lactate_max`, though improved from before incorporating time x covariate split.


2) Schoenfeld Residuals

The Schoenfeld residuals represent the difference between the observed covariates and expected value for the individuals who failed (i.e. did not survive). In the graphs of the scaled Schoenfeld residuals, the blue dotted line is a smoothing spline fit to the residuals (black dots), with the dashed red line representing the zero line. Systematic departures from the red horizontal line are indicative of non-proportional hazards, since proportional hazards assumes that estimates do not vary much over time. Graphical inspection does not show systematic departures from the zero line over time. 


### Re-fitting the model to the original data:

```{r task2.7}

##Compare model on df0 to df1

# Remove the missing data for the variables in the final model
# (this is what R would have done anyway when fitting to the model with missing data, as we saw in Task 1)
nm_icu_model_df0 <- na.omit(subset(icu_patients_df0, 
                                    select=c(Days, Status,
                                             RecordID, 
                                             Age, ICUType, Albumin_min, 
                                             Bilirubin_max, BUN_max, GCS_max, 
                                             HCO3_min, HR_min, Lactate_max, Na_max, 
                                             pH_min, Temp_max, Urine_min)))

dim(nm_icu_model_df0)

# Split the df0 dataset at the 90 day time point to allow direct comparison to the chosen final model
ICUdf0.split <- survSplit(Surv(Days, Status) ~ ., data = nm_icu_model_df0, cut=c(90), episode= "tgroup", id="id2")

# Refit the model to the df0, split dataset
ICU.final.coxdf0 <- coxph(Surv(Days, Status) ~
                         Age + ICUType:strata(tgroup) + 
                         Albumin_min:strata(tgroup) + 
                         Bilirubin_max:strata(tgroup) + BUN_max + 
                         GCS_max:strata(tgroup) + HCO3_min:strata(tgroup) + 
                         HR_min:strata(tgroup) + Lactate_max:strata(tgroup) + 
                         Na_max + pH_min + Temp_max + Urine_min,
                         data = ICUdf0.split)

summary(ICU.final.coxdf0)

```
In order to fit the final model to the original dataset, we first manually remove the missing data for the variables in the final model, which allows us to split the df0 dataset at the 90 day timepoint - to remain consistent with the dataset used in the final model. As we saw in Task 1, `R` would have removed the observations with missing data when attempting to fit the model to the original dataset, but here we do this manually to allow the splitting of the dataset to work.

Difference when fitted to dataset without imputed values of missing observations (df0):

* The dataset for fitting reduces from 2,061 individuals in df1 to 299 individuals in df0. With significantly fewer data points to fit the model, we observe the following differences:
    * Variables that were significant in the model fitted to df1 are no longer significant for the model on df0.
    * The coefficient estimates are significantly different for `pH`, `Temp_max`, `ICUType` and `Albumin` which leads to vastly different inferences on the impact of these variables on mortality risk.
    * The confidence intervals are much wider for the model on df0 reflecting the fewer data points, which increases the uncertainty (decreases precision) in the estimation of coefficients. 

<br>


**Summary of findings of the final model:**

Our Cox proportional hazards survival model of the icu_patients_df1 dataset is based on initial variables selected due to known association with morbidity and mortality either individually or as part of a validated ICU risk score (SOFA, SAPS1 and APACHE). Based on initial EDA, variables with a large proportion of missing data were excluded from the analysis (`Height`, `NISysABP_min`, `NISysABP_max`).

After analysing a series of fitted Cox proportional hazard models and addressing issues with assumptions, as explained above, we arrive at the final chosen model to predict overall survival in patients who had been admitted to ICU for >48 hours: `ICU.final.cox`.

Indepth discussion of the hazard rates for individual parameters is outlined above. The final Cox proportional hazards model suggests that in the first 24 hours of ICU admission, age, maximum BUN, maximum sodium, maximum temperature, minimum pH, minimum urine output, as well as ICU type, minimum albumin, minimum bicarbonate (HCO3), minimum heart rate, maximum bilirubin, maximum GCS and maximum lactate when stratified by survival lesser or greater than 90 days, predicts overall survival in adult ICU patients with ICU admissions >48 hours.

Based on our final model, ICU patients who have longer overall survival, in the first 24 hours of ICU admission, had lower age, lower maximum urea, higher maximum sodium, higher minimum pH, higher maximum temperature and higher maximum GCS scores. For patients that did not survive past 90 days, their survival was longer with higher minimum albumin, lower minimum heart rate and lower maximum lactate. For patients who did survive past 90 days, their survival was longer with lower minimum bicarbonate (HCO3) levels. Patients also had longer overall survival in Surgical ICU compared to Medical ICU, and in Cardiac Surgery Recovery Unit compared to Surgical ICU.

Individual predictors that had a large magnitude of effect on survival include age and minimum pH, as well as the stratified variables (by survival more or less than 90 days) of minimum albumin, type of ICU admission and maximum GCS. 

<br>
<br>

## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works, and then submit via the drop box in OpenLearning.

## Submit your assignment

When you have finished, and are satisfied with your assignment solutions, and this file knits without errors and the output looks the way you want, then you should submit via the drop box in OpenLearning.

### Problems?

If you encounter problems with any part of the process described above, please contact the course convenor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assignment is due.


### Additional Information

Each task attracts the indicated number of marks (out of a total of 30 marks for the assignment). The instructions are deliberately open-ended and less prescriptive than the individual assignments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks and gain full marks, you only need to replicate or repeat the steps covered in the course - if you do most or all of the things described in the revalant chapters of the HDAT9600 course, full marks will be awarded. 

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course convenor.
